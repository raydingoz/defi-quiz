<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Defi SimÃ¼latÃ¶rÃ¼ â€“ KatÄ±lÄ±mcÄ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --border: #1f2937;
      --accent: #22c55e;
      --danger: #f97373;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --heading: #f9fafb;
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 8px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
      color: var(--text);
      font-size: 15px;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 10px 10px;
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.9);
      margin-top: 8px;
    }

    .brand {
      font-weight: 700;
      font-size: 1.06rem;
      color: var(--heading);
    }

    .pill {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border);
      padding: 3px 9px;
      font-size: 0.8rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15,23,42,0.9);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .scenario-title {
      font-size: 0.92rem;
      color: var(--heading);
      margin-bottom: 3px;
    }

    .scenario-text {
      font-size: 0.88rem;
      color: var(--text);
      margin-bottom: 4px;
      max-height: 120px;
      overflow-y: auto;
    }

    .helper {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
    }

    .btn {
      border: none;
      border-radius: var(--radius-pill);
      padding: 10px 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease-out;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      outline: none;
      width: 100%;
    }

    .btn-main {
      background: radial-gradient(circle at top left, #fb923c, #f97316);
      color: #0b1120;
      box-shadow: 0 10px 20px rgba(248,113,22,0.55);
    }

    .btn-cardio {
      background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      color: #020617;
      box-shadow: 0 10px 20px rgba(56,189,248,0.55);
    }

    .btn-sec {
      background: rgba(15,23,42,0.95);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .btn-small {
      font-size: 0.8rem;
      padding: 6px 10px;
    }

    .btn[disabled] {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }

    .input-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    input[type="text"] {
      flex: 1;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border);
      padding: 8px 10px;
      background: #020617;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }

    input[type="text"]::placeholder {
      color: var(--muted);
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .feedback {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .feedback.ok { color: var(--accent); }
    .feedback.bad { color: var(--danger); }

    .badge-answer {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top-bar">
      <div class="brand">Defi SimÃ¼latÃ¶rÃ¼</div>
      <div class="pill">
        <span class="pill-dot"></span>
        Skorun: <span id="myScore">0</span> puan
      </div>
    </div>

    <!-- Nickname kartÄ± -->
    <div class="card" id="joinCard">
      <div class="scenario-title">KatÄ±l</div>
      <div class="helper">
        Nickini yaz, eÄŸitmenin baÅŸlattÄ±ÄŸÄ± workshop oturumuna baÄŸlan.
      </div>
      <div class="input-row">
        <input id="nicknameInput" type="text" maxlength="20"
               placeholder="Ã–rn. KardiyoRafi" />
        <button id="joinBtn" class="btn btn-small btn-main">KatÄ±l</button>
      </div>
      <div id="joinFeedback" class="feedback"></div>
    </div>

    <!-- Soru kartÄ± -->
    <div class="card" id="quizCard" style="display:none;">
      <div class="scenario-title" id="scenarioTitle">Olgu baÅŸlÄ±ÄŸÄ±</div>
      <div class="scenario-text" id="scenarioText">Olgular eÄŸitmen tarafÄ±ndan baÅŸlatÄ±lacak.</div>

      <div class="meta-row">
        <span>Olgular eÄŸitmen ekranÄ±na gÃ¶re ilerliyor.</span>
        <span>Olgu: <span id="sceneIndex">â€“</span>/<span id="sceneTotal">â€“</span></span>
      </div>

      <div class="controls">
        <button id="defibBtn" class="btn btn-main" disabled>
          âš¡ Defibrilasyon (200 J)
        </button>
        <button id="cardioBtn" class="btn btn-cardio" disabled>
          âš¡ Senkron kardiyoversiyon
        </button>
        <button id="noShockBtn" class="btn btn-sec" disabled>
          ðŸ¤š Åžok yok / KPR / ilaÃ§
        </button>
      </div>

      <div id="answerStatus" class="badge-answer">
        EÄŸitmen yeni bir soru baÅŸlattÄ±ÄŸÄ±nda butonlar aktif olacaktÄ±r.
      </div>
      <div id="questionInfo" class="feedback"></div>
    </div>

    <!-- Info kartÄ± -->
    <div class="card">
      <div class="scenario-title">Bilgi</div>
      <div class="helper">
        Bu uygulama, ERC 2025 ALS defibrilasyon ve kardiyoversiyon kararlarÄ±nÄ± tartÄ±ÅŸmak iÃ§in
        hazÄ±rlanmÄ±ÅŸ interaktif bir araÃ§tÄ±r; gerÃ§ek hasta yÃ¶netiminin yerini tutmaz.
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDzzwE5VHZAiP2k8P_iocDaq7uGm1zN1cE",
      authDomain: "defi-quiz.firebaseapp.com",
      databaseURL: "https://defi-quiz-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "defi-quiz",
      storageBucket: "defi-quiz.firebasestorage.app",
      messagingSenderId: "642741899462",
      appId: "1:642741899462:web:bcc787a87d0ec69c9b47c7",
      measurementId: "G-SY348RPCVZ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const rootRef = db.ref("defiSim");

    const SCENES = [
      { id: 1, correctAction: "defib" },
      { id: 2, correctAction: "no-shock" },
      { id: 3, correctAction: "cardioversion" },
      { id: 4, correctAction: "cardioversion" },
      { id: 5, correctAction: "no-shock" },
      { id: 6, correctAction: "no-shock" },
      { id: 7, correctAction: "defib" },
      { id: 8, correctAction: "defib" }
    ];

    // AynÄ± metinleri host ile tutarlÄ± yapmak iÃ§in:
    const SCENE_TEXTS = [
      {
        title: "Olgu 1 â€“ Ani kollaps",
        text:
          "65 yaÅŸ erkek, acil serviste triyaj sÄ±rasÄ±nda aniden yere yÄ±ÄŸÄ±lÄ±yor. Bilinci kapalÄ±, solunum normal deÄŸil, palpabl nabÄ±z alÄ±namÄ±yor. Ekip olarak KPR baÅŸlatÄ±yorsunuz ve monitÃ¶re baÄŸlanÄ±yorsunuz."
      },
      {
        title: "Olgu 2 â€“ Åžok sonrasÄ± deÄŸerlendirme",
        text:
          "AynÄ± hastaya bir ÅŸok uygulandÄ± ve 2 dk KPR yapÄ±ldÄ±. Åžimdi kÄ±sa ritim kontrolÃ¼ndesiniz. Hasta gÃ¶zlerini aÃ§Ä±yor, komut alÄ±yor ve hareket etmeye baÅŸlÄ±yor."
      },
      {
        title: "Olgu 3 â€“ GenÃ§ eriÅŸkin, hipotansif taÅŸikardi",
        text:
          "35 yaÅŸ kadÄ±n, Ã§arpÄ±ntÄ± ve baÅŸ dÃ¶nmesi ile geliyor. TA 70/40 mmHg, soÄŸuk, soluk, bilinÃ§ bulanÄ±k. NabÄ±z Ã§ok hÄ±zlÄ± ve dÃ¼zenli hissediliyor."
      },
      {
        title: "Olgu 4 â€“ YaÅŸlÄ± hasta, kronik aritmi Ã¶ykÃ¼sÃ¼",
        text:
          "72 yaÅŸ erkek, uzun sÃ¼redir dÃ¼zensiz kalp atÄ±mÄ± Ã¶ykÃ¼sÃ¼ var. Åžimdi gÃ¶ÄŸÃ¼s aÄŸrÄ±sÄ±, nefes darlÄ±ÄŸÄ± ve sersemlik ile geliyor. TA 80/50 mmHg, nabÄ±z hÄ±zlÄ± ve dÃ¼zensiz."
      },
      {
        title: "Olgu 5 â€“ NabÄ±zsÄ±z, elektriksel aktivite belirsiz",
        text:
          "Acilde yatan bir hastaya Ã§aÄŸrÄ±lÄ±yorsunuz. YataÄŸÄ±nda yanÄ±tsÄ±z, normal solumuyor ve palpabl nabÄ±z alÄ±namÄ±yor. Ekip KPR baÅŸlatÄ±yor, sen monitÃ¶re bakÄ±yorsun."
      },
      {
        title: "Olgu 6 â€“ NabÄ±z yok, monitÃ¶rde elektriksel aktivite",
        text:
          "Ä°leri yaÅŸ bir hasta, serviste ani kÃ¶tÃ¼leÅŸme sonrasÄ± acile alÄ±nÄ±yor. MonitÃ¶rde bir ritim gÃ¶rÃ¼yorsun ancak nabÄ±z palpe edemiyorsun. Hasta yanÄ±tsÄ±z ve apneik."
      },
      {
        title: "Olgu 7 â€“ GeniÅŸ kompleks, nabÄ±z alÄ±namÄ±yor",
        text:
          "50 yaÅŸ erkek, gÃ¶ÄŸÃ¼s aÄŸrÄ±sÄ± sonrasÄ± aniden bilincini kaybediyor. Olay yerinde ve acilde nabÄ±z alÄ±namÄ±yor. MonitÃ¶rde hÄ±zlÄ±, geniÅŸ kompleksli elektriksel aktivite gÃ¶rÃ¼yorsun."
      },
      {
        title: "Olgu 8 â€“ UzamÄ±ÅŸ QT Ã¶ykÃ¼lÃ¼ hasta",
        text:
          "UzamÄ±ÅŸ QT Ã¶ykÃ¼sÃ¼ olan bir hasta, Ã§arpÄ±ntÄ± sonrasÄ± ani olarak bilincini kaybediyor. NabÄ±z alÄ±namÄ±yor. MonitÃ¶rde ÅŸekli zaman iÃ§inde deÄŸiÅŸen hÄ±zlÄ± bir ritim gÃ¶rÃ¼yorsun."
      }
    ];

    const joinCard = document.getElementById("joinCard");
    const quizCard = document.getElementById("quizCard");
    const nicknameInput = document.getElementById("nicknameInput");
    const joinBtn = document.getElementById("joinBtn");
    const joinFeedback = document.getElementById("joinFeedback");

    const scenarioTitle = document.getElementById("scenarioTitle");
    const scenarioText = document.getElementById("scenarioText");
    const defibBtn = document.getElementById("defibBtn");
    const cardioBtn = document.getElementById("cardioBtn");
    const noShockBtn = document.getElementById("noShockBtn");
    const answerStatus = document.getElementById("answerStatus");
    const questionInfo = document.getElementById("questionInfo");
    const myScoreSpan = document.getElementById("myScore");
    const sceneIndexSpan = document.getElementById("sceneIndex");
    const sceneTotalSpan = document.getElementById("sceneTotal");

    sceneTotalSpan.textContent = SCENES.length;

    let playerId = null;
    let nickname = null;
    let currentQuestionId = null;
    let currentSceneIndex = null;
    let answeredQuestions = {}; // qId -> true

    // localStorage'da varsa kullan
    const storedId = localStorage.getItem("defiSimPlayerId");
    const storedNick = localStorage.getItem("defiSimNickname");
    if (storedId && storedNick) {
      playerId = storedId;
      nickname = storedNick;
      joinCard.style.display = "none";
      quizCard.style.display = "block";
      answerStatus.textContent = "EÄŸitmen yeni soru baÅŸlattÄ±ÄŸÄ±nda butonlar aktif olacak.";
    }

    function enableAnswerButtons(enable) {
      defibBtn.disabled = !enable;
      cardioBtn.disabled = !enable;
      noShockBtn.disabled = !enable;
    }

    function joinSession() {
      const nick = nicknameInput.value.trim();
      if (!nick) {
        joinFeedback.textContent = "LÃ¼tfen bir nick yaz.";
        return;
      }
      nickname = nick;
      if (!playerId) {
        playerId = "p_" + Math.random().toString(36).substr(2, 9);
      }
      const playerRef = rootRef.child("players").child(playerId);
      playerRef.update({ nickname: nickname, score: 0 });
      localStorage.setItem("defiSimPlayerId", playerId);
      localStorage.setItem("defiSimNickname", nickname);
      joinCard.style.display = "none";
      quizCard.style.display = "block";
      answerStatus.textContent = "EÄŸitmen yeni soru baÅŸlattÄ±ÄŸÄ±nda butonlar aktif olacak.";
      joinFeedback.textContent = "";
    }

    joinBtn.addEventListener("click", joinSession);
    nicknameInput.addEventListener("keydown", e => {
      if (e.key === "Enter") joinSession();
    });

    // Skor dinle
    function attachScoreListener() {
      if (!playerId) return;
      rootRef.child("players").child(playerId).child("score")
        .on("value", snap => {
          const val = snap.val() || 0;
          myScoreSpan.textContent = val;
        });
    }

    // Yeni soru dinleyicileri
    rootRef.child("currentSceneIndex").on("value", snap => {
      const idx = snap.val();
      if (idx === null || idx === undefined) return;
      currentSceneIndex = idx;
      const sText = SCENE_TEXTS[idx] || {};
      sceneIndexSpan.textContent = idx + 1;
      scenarioTitle.textContent = sText.title || ("Olgu " + (idx + 1));
      scenarioText.textContent = sText.text || "";
    });

    rootRef.child("currentQuestionId").on("value", snap => {
      const qId = snap.val();
      if (!qId) {
        currentQuestionId = null;
        enableAnswerButtons(false);
        questionInfo.textContent = "EÄŸitmen henÃ¼z soru baÅŸlatmadÄ±.";
        return;
      }
      currentQuestionId = qId;
      questionInfo.textContent =
        "Yeni soru baÅŸladÄ±. DoÄŸru yanÄ±t verenler iÃ§inde ilk 6 kiÅŸi daha yÃ¼ksek puan alÄ±r.";
      if (answeredQuestions[qId]) {
        enableAnswerButtons(false);
        answerStatus.textContent = "Bu soruya zaten cevap verdin.";
      } else {
        enableAnswerButtons(true);
        answerStatus.textContent = "SeÃ§imini yap. YanÄ±tÄ±n geri alÄ±namaz.";
      }
    });

    function describeActionKey(key) {
      if (key === "defib") return "defibrilasyon";
      if (key === "cardioversion") return "senkron kardiyoversiyon";
      if (key === "no-shock") return "ÅŸok yok / KPR / ilaÃ§";
      return "uygun yaklaÅŸÄ±m";
    }

    function computePoints(orderPosition) {
      if (orderPosition <= 0) return 0;
      if (orderPosition === 1) return 20;
      if (orderPosition === 2) return 19;
      if (orderPosition === 3) return 18;
      if (orderPosition === 4) return 17;
      if (orderPosition === 5) return 16;
      // 6 ve sonrasÄ±
      return 15;
    }

    function sendAnswer(actionType) {
      if (!playerId || currentQuestionId == null || currentSceneIndex == null) return;
      if (answeredQuestions[currentQuestionId]) return;

      const scene = SCENES[currentSceneIndex] || {};
      const correctAction = scene.correctAction;
      const isCorrect = (actionType === correctAction);

      enableAnswerButtons(false);
      answeredQuestions[currentQuestionId] = true;
      answerStatus.textContent = "CevabÄ±n kaydedildi. EÄŸitmenle birlikte aÃ§Ä±klamayÄ± dinle.";

      const answersRef = rootRef.child("answers").child(String(currentQuestionId));
      const playerAnswerRef = answersRef.child(playerId);

      if (!isCorrect) {
        playerAnswerRef.set({
          nickname: nickname || "Anonim",
          answer: actionType,
          correct: false,
          points: 0,
          ts: Date.now()
        });
        questionInfo.textContent =
          "YanlÄ±ÅŸ/uygunsuz yaklaÅŸÄ±m. DoÄŸru stratejiyi eÄŸitmen ekranÄ±ndan takip et.";
        questionInfo.className = "feedback bad";
        return;
      }

      // DoÄŸruysa, order hesaplayÄ±p puan ver
      const orderRef = rootRef.child("answerOrder").child(String(currentQuestionId));
      orderRef.transaction(cur => (cur || 0) + 1, (err, committed, snap) => {
        if (!committed || !snap) return;
        const position = snap.val();
        const pts = computePoints(position);

        playerAnswerRef.set({
          nickname: nickname || "Anonim",
          answer: actionType,
          correct: true,
          position: position,
          points: pts,
          ts: Date.now()
        });

        const playerScoreRef = rootRef.child("players").child(playerId).child("score");
        playerScoreRef.transaction(cur => (cur || 0) + pts);

        questionInfo.textContent =
          "DoÄŸru yaklaÅŸÄ±mdÄ±. Bu soruda sÄ±ralamadaki yerin: " + position +
          ". AldÄ±ÄŸÄ±n puan: " + pts + ".";
        questionInfo.className = "feedback ok";
      });
    }

    defibBtn.addEventListener("click", () => sendAnswer("defib"));
    cardioBtn.addEventListener("click", () => sendAnswer("cardioversion"));
    noShockBtn.addEventListener("click", () => sendAnswer("no-shock"));

    // localStorage'dan geldiysen skor listener'Ä± baÄŸla
    if (playerId) attachScoreListener();
    else {
      // join sonrasÄ± baÄŸlanacak
      rootRef.child("players").once("value", () => {});
    }

    // Join sonrasÄ± skor listener'Ä± baÄŸlamak iÃ§in kÃ¼Ã§Ã¼k gecikme
    joinBtn.addEventListener("click", () => {
      setTimeout(attachScoreListener, 500);
    });
  </script>
</body>
</html>
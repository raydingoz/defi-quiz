<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Defibrilasyon & Kardiyoversiyon Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #020617;
      --card: #0b1120;
      --card-soft: #020617;
      --border: #1e293b;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent-strong: #4ade80;
      --danger: #f97373;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --heading: #f9fafb;
      --radius-lg: 20px;
      --radius-pill: 999px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 50%, #000 100%);
      color: var(--text);
    }

    .app-shell {
      max-width: 960px;
      margin: 0 auto;
    }

    #connectionBanner {
      background: #7f1d1d;
      color: #fee2e2;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      text-align: center;
      margin-bottom: 8px;
      box-shadow: 0 0 0 1px rgba(248,113,113,0.6);
    }
    .hidden { display: none; }

    #modeInfo {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #modeInfo::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle, var(--accent-strong), var(--accent));
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.9);
    }

    h1 {
      margin: 4px 0 12px;
      font-size: 1.4rem;
      color: var(--heading);
    }
    h2 {
      margin: 0 0 8px;
      font-size: 1rem;
      color: var(--heading);
    }
    p {
      margin: 4px 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .card {
      background: linear-gradient(135deg, var(--card) 0%, #020617 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 14px 16px;
      margin-top: 12px;
      box-shadow: 0 20px 35px rgba(15, 23, 42, 0.8);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      border: 1px solid var(--border);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #020617;
    }
    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .btn {
      border: none;
      border-radius: var(--radius-pill);
      padding: 10px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease-out;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      outline: none;
    }
    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #022c22;
      box-shadow: 0 12px 25px rgba(34, 197, 94, 0.35);
    }
    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 6px 15px rgba(34, 197, 94, 0.3);
    }
    .btn-secondary {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .btn-secondary:active { transform: translateY(1px); }
    .btn-sm { padding: 6px 10px; font-size: 0.8rem; }

    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: 0.95rem;
      outline: none;
    }
    input[type="text"]::placeholder { color: #64748b; }
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3);
    }

    .status-text {
      font-size: 0.8rem;
      margin-top: 4px;
    }
    .status-text.error { color: var(--danger); }
    .status-text.success { color: var(--accent-strong); }
    .status-text.info { color: var(--muted); }

    #qrcode {
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #playerLink {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      word-break: break-all;
      color: var(--accent-strong);
    }

    .question-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 4px;
      gap: 6px;
      flex-wrap: wrap;
    }

    .question-text {
      font-size: 0.95rem;
      color: var(--heading);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .question-image {
      margin-top: 4px;
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      display: block;
    }

    .options-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .option-label {
      display: block;
      position: relative;
      cursor: pointer;
    }
    .option-label input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .option-card {
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.15s ease-out;
    }
    .option-card[data-letter] { position: relative; }

    .option-letter {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: var(--muted);
      background: radial-gradient(circle at top, #020617 0, #000 100%);
      flex-shrink: 0;
    }

    .option-text {
      font-size: 0.9rem;
      color: var(--text);
    }

    .option-label input[type="radio"]:focus + .option-card,
    .option-label input[type="radio"]:checked + .option-card {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3);
      background: linear-gradient(135deg, rgba(22, 163, 74, 0.12), rgba(15, 23, 42, 0.95));
    }
    .option-label input[type="radio"]:checked + .option-card .option-letter {
      border-color: var(--accent-strong);
      color: var(--accent-strong);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    .option-card-correct {
      border-color: var(--accent-strong) !important;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
    }
    .option-card-dim { opacity: 0.55; }

    .timer-text {
      font-size: 0.9rem;
      margin-top: 4px;
      color: var(--muted);
    }
    .timer-hot {
      color: var(--accent-strong);
      font-weight: 600;
    }
    .timer-critical {
      color: var(--danger);
      font-weight: 700;
      font-size: 1.05rem;
    }

    .table-wrapper {
      margin-top: 6px;
      border-radius: 14px;
      border: 1px solid var(--border);
      overflow: hidden;
      background: rgba(15, 23, 42, 0.9);
      max-height: 260px;
      overflow-y: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.85rem;
    }
    thead {
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.13), rgba(15, 23, 42, 0.96));
    }
    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(30, 41, 59, 0.8);
    }
    th {
      color: var(--muted);
      font-weight: 500;
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.13), rgba(15, 23, 42, 0.96));
    }
    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.85);
    }
    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.95);
    }

    @media (min-width: 768px) {
      body { padding: 24px; }
      .card { padding: 16px 18px; }
      h1 { font-size: 1.6rem; }
      .host-layout {
        display: grid;
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
        gap: 12px;
      }
    }
  </style>

  <!-- QR code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase v8 (app + realtime db) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div class="app-shell">
    <div id="connectionBanner" class="hidden">
      Bağlantı yok, tekrar bağlanmaya çalışılıyor...
    </div>

    <div id="modeInfo"></div>

    <!-- EĞİTMEN ALANI -->
    <div id="hostArea" class="hidden">
      <h1>Defibrilasyon & Kardiyoversiyon Quiz</h1>

      <div class="host-layout">
        <div>
          <div class="card">
            <div class="card-header">
              <h2>Oturum Durumu</h2>
              <span class="badge">
                <span class="badge-dot"></span>
                Eğitmen
              </span>
            </div>
            <p id="hostStatus" class="status-text info">Hazır.</p>
            <button id="resetBtn" class="btn btn-secondary btn-sm">
              Oturumu Sıfırla
            </button>
          </div>

          <div class="card">
            <div class="card-header">
              <h2>Aktif Olgu</h2>
              <span class="badge">
                Süreli soru
              </span>
            </div>
            <div class="question-meta">
              <span id="hostQuestionMeta">Henüz soru başlatılmadı.</span>
              <span id="hostTimer" class="timer-text"></span>
            </div>
            <div class="question-text" id="hostQuestionTitle">
              Henüz soru başlatılmadı.
            </div>
            <img id="hostQuestionImage" class="question-image hidden" alt="Olgu görseli" />
            <div class="options-grid" id="hostOptionsList"></div>
            <p id="hostExplanation" class="status-text hidden"></p>
            <button id="nextQuestionBtn" class="btn btn-primary" style="margin-top:10px;">
              Sonraki olguyu başlat
            </button>
          </div>
        </div>

        <div>
          <div class="card">
            <div class="card-header">
              <h2>Katılım QR Kodu</h2>
            </div>
            <p class="status-text info">
              Katılımcılar telefonlarından QR'ı okutarak katılabilir.
            </p>
            <div id="qrcode"></div>
            <p style="margin-top:10px;">Katılımcı adresi:</p>
            <p id="playerLink"></p>
          </div>

          <div class="card">
            <div class="card-header">
              <h2>Liderlik Tablosu</h2>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Nick</th>
                    <th>Puan</th>
                  </tr>
                </thead>
                <tbody id="hostScoreBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- KATILIMCI ALANI -->
    <div id="playerArea" class="hidden">
      <h1>Quiz Katılım Ekranı</h1>

      <div id="joinStep" class="card">
        <div class="card-header">
          <h2>Katıl</h2>
          <span class="badge">
            <span class="badge-dot"></span>
            Mobil katılımcı
          </span>
        </div>
        <p class="status-text info">
          Nick seç, "Katıl" butonuna bas. Aynı cihazdan tekrar girersen kaldığın skorla devam edersin (reset sonrası tekrar katılman gerekir).
        </p>
        <label style="margin-top:8px; font-size:0.9rem;">
          Nick:
          <input type="text" id="nickInput" placeholder="Örn. VF_master, ALS_pro, HomerED" />
        </label>
        <button id="joinBtn" class="btn btn-primary" style="margin-top:10px;">
          Katıl
        </button>
        <p id="joinMsg" class="status-text"></p>
      </div>

      <div id="playStep" class="card hidden">
        <div class="card-header">
          <h2>Aktif Olgu</h2>
          <span class="badge" id="playerQuestionBadge">Soru bekleniyor</span>
        </div>
        <p id="helloPlayer" class="status-text info"></p>

        <div class="question-meta">
          <span id="playerQuestionMeta"></span>
          <span id="playerTimer" class="timer-text"></span>
        </div>
        <div id="playerQuestionTitle" class="question-text">
          Soru bekleniyor...
        </div>
        <img id="playerQuestionImage" class="question-image hidden" alt="Olgu görseli" />

        <div id="playerOptions" class="options-grid"></div>

        <button id="answerBtn" class="btn btn-primary" style="margin-top:12px;" disabled>
          Cevapla
        </button>
        <p id="answerMsg" class="status-text" style="margin-top:6px;"></p>
        <p id="playerExplanation" class="status-text" style="margin-top:4px;"></p>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Liderlik (ilk 10)</h2>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Nick</th>
                <th>Puan</th>
              </tr>
            </thead>
            <tbody id="playerScoreBody"></tbody>
          </table>
        </div>
      </div>

      <div id="finishedStep" class="card hidden">
        <h2>Quiz Tamamlandı</h2>
        <p class="status-text success">
          Katıldığın için teşekkürler. Nihai skorlar aşağıda.
        </p>
        <p id="summaryScore" class="status-text"></p>
        <p id="summaryDetail" class="status-text"></p>
      </div>
    </div>
  </div>

  <script>
    /*************** 1) AYARLAR ***************/

    // Senin Firebase config'in
    const firebaseConfig = {
      apiKey: "AIzaSyDzzwE5VHZAiP2k8P_iocDaq7uGm1zN1cE",
      authDomain: "defi-quiz.firebaseapp.com",
      databaseURL: "https://defi-quiz-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "defi-quiz",
      storageBucket: "defi-quiz.firebasestorage.app",
      messagingSenderId: "642741899462",
      appId: "1:642741899462:web:bcc787a87d0ec69c9b47c7",
      measurementId: "G-SY348RPCVZ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Oturum kimliği (farklı workshoplar için parametreye de bağlayabiliriz)
    const params = new URLSearchParams(window.location.search);
    const sessionParam = params.get("session") || "erc-quiz-als-2025";
    const SESSION_ID = sessionParam;

    // Default süre (ms) – soru bazlı timeLimitMs ile override edilebilir
    const DEFAULT_TIME_LIMIT_MS = 10000; // 10 sn

    // Varsayılan sorular (questions.json yoksa bunlar kullanılacak)
    const DEFAULT_QUESTIONS = [
      {
        text: "Olgu 1: 65 yaş, tanıklı VF arrest; 2. şok sonrası ritim hala VF. Ne yaparsın?",
        options: [
          "Hemen üçüncü şoku uygularım",
          "2 dk KPR, sonra ritim kontrolü ve uygun ise tekrar şok",
          "Lidokain 1 mg/kg iv bolus, şok yok",
          "Atropin 1 mg iv veririm"
        ],
        correct: "B",
        timeLimitMs: 8000,
        explanation: "2025 ERC ALS: Şoklanabilir ritimde her şoktan sonra 2 dk yüksek kaliteli KPR, aralarda ritim/anlam kontrolü; 3'lü şok yok.",
        isDemo: true
      },
      {
        text: "Olgu 2: Stabil düzenli SVT, dar QRS, semptomlu. İlk yaklaşım?",
        options: [
          "Amiodaron yükleme",
          "Senkronize kardiyoversiyon",
          "Vagal manevra, başarısızsa adenozin",
          "Magnezyum sülfat"
        ],
        correct: "C",
        timeLimitMs: 12000,
        explanation: "Hemodinamik olarak stabil, dar QRS SVT'de ilk basamak vagal manevralar; başarısız olursa adenozin."
      },
      {
        text: "Olgu 3: Bilinci kapalı, monitörde kaba VF. İlk yapılacak?",
        options: [
          "1 dk ritim analizi",
          "Senkronize kardiyoversiyon",
          "Hemen defibrilasyon + KPR",
          "1 mg adrenalin iv"
        ],
        correct: "C",
        timeLimitMs: 10000,
        explanation: "Tanıklı VF/pulssuz VT'de mümkün olan en kısa sürede defibrilasyon, ardından KPR."
      }
    ];

    let QUESTIONS = DEFAULT_QUESTIONS;

    function sessionRef(path) {
      return db.ref("sessions/" + SESSION_ID + (path ? "/" + path : ""));
    }

    /*************** 2) SORULARI JSON'DAN YÜKLEME ***************/
    function loadQuestions() {
      // Aynı dizinde questions.json varsa oradan yüklemeye çalış
      return fetch("questions.json", { cache: "no-store" })
        .then(resp => {
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          return resp.json();
        })
        .then(data => {
          if (Array.isArray(data)) {
            QUESTIONS = data;
          } else if (data && Array.isArray(data.questions)) {
            QUESTIONS = data.questions;
          } else {
            console.warn("questions.json formatı beklenenden farklı, varsayılan sorular kullanılacak.");
            QUESTIONS = DEFAULT_QUESTIONS;
          }
        })
        .catch(err => {
          console.warn("questions.json yüklenemedi, varsayılan sorular kullanılacak:", err);
          QUESTIONS = DEFAULT_QUESTIONS;
        });
    }

    /*************** 3) BAĞLANTI DURUMU ***************/
    function initConnectionMonitor() {
      const connectionBanner = document.getElementById("connectionBanner");
      db.ref(".info/connected").on("value", snap => {
        const val = snap.val();
        if (val === true) {
          connectionBanner.classList.add("hidden");
        } else {
          connectionBanner.classList.remove("hidden");
        }
      });
    }

    /*************** 4) GENEL DEĞİŞKENLER ***************/
    const IS_HOST = params.get("host") === "1";

    const modeInfo = document.getElementById("modeInfo");
    const hostArea = document.getElementById("hostArea");
    const playerArea = document.getElementById("playerArea");

    /*************** 5) EĞİTMEN TARAFI ***************/
    let currentQuestionIndex = -1;
    let hostCountdownInterval = null;
    let gradeTimeout = null;
    let hostCurrentQId = null;

    function initHost() {
      hostArea.classList.remove("hidden");
      modeInfo.textContent = "Mod: Eğitmen (projeksiyona bu ekranı ver)";

      const hostStatus = document.getElementById("hostStatus");
      const resetBtn = document.getElementById("resetBtn");
      const qrcodeDiv = document.getElementById("qrcode");
      const playerLinkSpan = document.getElementById("playerLink");
      const nextQuestionBtn = document.getElementById("nextQuestionBtn");
      const hostQuestionTitle = document.getElementById("hostQuestionTitle");
      const hostOptionsList = document.getElementById("hostOptionsList");
      const hostTimer = document.getElementById("hostTimer");
      const hostScoreBody = document.getElementById("hostScoreBody");
      const hostQuestionMeta = document.getElementById("hostQuestionMeta");
      const hostExplanation = document.getElementById("hostExplanation");
      const hostQuestionImage = document.getElementById("hostQuestionImage");

      const playerUrl = window.location.origin + window.location.pathname;
      playerLinkSpan.textContent = playerUrl;

      new QRCode(qrcodeDiv, {
        text: playerUrl,
        width: 180,
        height: 180
      });

      sessionRef("players").on("value", (snap) => {
        const list = [];
        snap.forEach((child) => {
          const v = child.val() || {};
          list.push({
            nickname: v.nickname || "???",
            score: v.score || 0
          });
        });
        list.sort((a, b) => b.score - a.score);

        hostScoreBody.innerHTML = "";
        list.forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${idx + 1}</td><td>${p.nickname}</td><td>${p.score}</td>`;
          hostScoreBody.appendChild(tr);
        });
      });

      sessionRef("state").on("value", (snap) => {
        const st = snap.val();
        if (!st) return;
        if (st.status === "ended") {
          hostStatus.textContent = "Quiz bitti. Nihai skorlar tabloda.";
          hostStatus.className = "status-text success";
          if (hostCountdownInterval) clearInterval(hostCountdownInterval);
          if (gradeTimeout) clearTimeout(gradeTimeout);
          hostTimer.textContent = "";
        } else if (st.status === "waiting") {
          hostStatus.textContent = "Oturum hazır. Katılımcılar tekrar katılabilir.";
          hostStatus.className = "status-text info";
        }
      });

      // Açıklama dinleyicisi
      sessionRef("currentExplanation").on("value", (snap) => {
        const ex = snap.val();
        if (!ex || !hostCurrentQId || ex.qId !== hostCurrentQId) {
          hostExplanation.classList.add("hidden");
          hostExplanation.textContent = "";
          // Eski highlight'ları temizle
          hostOptionsList.querySelectorAll(".option-card").forEach(card => {
            card.classList.remove("option-card-correct", "option-card-dim");
          });
          return;
        }

        // Doğru şık highlight
        hostOptionsList.querySelectorAll(".option-card").forEach(card => {
          const letter = card.dataset.letter;
          if (letter === ex.correct) {
            card.classList.add("option-card-correct");
            card.classList.remove("option-card-dim");
          } else {
            card.classList.add("option-card-dim");
            card.classList.remove("option-card-correct");
          }
        });

        let text = "";
        if (ex.isDemo) {
          text += "[DEMO soru – puan yok] ";
        }
        if (ex.explanation) {
          text += ex.explanation;
        } else {
          text += "Doğru cevap: " + ex.correct;
        }
        hostExplanation.textContent = text;
        hostExplanation.classList.remove("hidden");
      });

      // Reset: tüm session'ı temizle + state: waiting
      resetBtn.onclick = () => {
        const payload = {
          state: {
            status: "waiting",
            resetAt: Date.now()
          }
        };
        sessionRef("").set(payload).then(() => {
          currentQuestionIndex = -1;
          hostCurrentQId = null;
          hostQuestionTitle.textContent = "Henüz soru başlatılmadı.";
          hostQuestionMeta.textContent = "Henüz soru yok";
          hostOptionsList.innerHTML = "";
          hostTimer.textContent = "";
          hostExplanation.textContent = "";
          hostExplanation.classList.add("hidden");
          hostQuestionImage.src = "";
          hostQuestionImage.classList.add("hidden");
        }).catch(err => {
          hostStatus.textContent = "Sıfırlama hatası: " + err.message;
          hostStatus.className = "status-text error";
        });
      };

      nextQuestionBtn.onclick = () => {
        startNextQuestion(hostStatus, hostQuestionTitle, hostOptionsList, hostTimer, hostQuestionMeta, hostExplanation, hostQuestionImage);
      };
    }

    function startNextQuestion(hostStatus, hostQuestionTitle, hostOptionsList, hostTimer, hostQuestionMeta, hostExplanation, hostQuestionImage) {
      currentQuestionIndex++;
      if (currentQuestionIndex >= QUESTIONS.length) {
        hostStatus.textContent = "Tüm olgular bitti. Yeni soru yok.";
        hostStatus.className = "status-text info";
        sessionRef("state").set({ status: "ended", index: currentQuestionIndex, finishedAt: Date.now() });
        return;
      }

      const q = QUESTIONS[currentQuestionIndex];
      const qId = "q" + currentQuestionIndex;
      const timeLimit = q.timeLimitMs || DEFAULT_TIME_LIMIT_MS;
      const startTime = Date.now();
      hostCurrentQId = qId;

      sessionRef("answers/" + qId).set(null);

      const qObj = {
        index: currentQuestionIndex + 1,
        total: QUESTIONS.length,
        text: q.text,
        options: q.options || [],
        correct: q.correct,
        qId: qId,
        startTime: startTime,
        timeLimitMs: timeLimit,
        imageUrl: q.imageUrl || null
      };

      sessionRef("currentQuestion").set(qObj);
      sessionRef("state").set({ status: "running", index: currentQuestionIndex });

      hostStatus.textContent = "Soru " + (currentQuestionIndex + 1) + "/" + QUESTIONS.length + " başlatıldı.";
      hostStatus.className = "status-text success";

      const seconds = Math.round(timeLimit / 1000);
      hostQuestionMeta.textContent = "Soru " + (currentQuestionIndex + 1) + " / " + QUESTIONS.length + " • Süre: " + seconds + " sn";
      hostQuestionTitle.textContent = q.text || "";
      hostOptionsList.innerHTML = "";
      hostExplanation.textContent = "";
      hostExplanation.classList.add("hidden");

      if (q.imageUrl) {
        hostQuestionImage.src = q.imageUrl;
        hostQuestionImage.classList.remove("hidden");
      } else {
        hostQuestionImage.src = "";
        hostQuestionImage.classList.add("hidden");
      }

      (q.options || []).forEach((opt, idx) => {
        const letter = String.fromCharCode(65 + idx);
        const div = document.createElement("div");
        div.className = "option-card";
        div.dataset.letter = letter;
        div.innerHTML = `
          <div class="option-letter">${letter}</div>
          <div class="option-text">${opt}</div>
        `;
        hostOptionsList.appendChild(div);
      });

      if (hostCountdownInterval) clearInterval(hostCountdownInterval);
      const endTime = startTime + timeLimit;
      function hostTick() {
        const now = Date.now();
        const remaining = endTime - now;
        if (remaining <= 0) {
          hostTimer.textContent = "Süre doldu. Puanlama yapılıyor...";
          hostTimer.className = "timer-text";
          clearInterval(hostCountdownInterval);
        } else {
          const sec = Math.ceil(remaining / 1000);
          hostTimer.textContent = "Kalan süre: " + sec + " sn";
          hostTimer.className = "timer-text " + (sec <= 3 ? "timer-critical" : "timer-hot");
        }
      }
      hostTick();
      hostCountdownInterval = setInterval(hostTick, 200);

      if (gradeTimeout) clearTimeout(gradeTimeout);
      gradeTimeout = setTimeout(() => {
        gradeQuestion(qId, q.correct, timeLimit);
      }, timeLimit + 500);
    }

    function gradeQuestion(qId, correctLetter, timeLimit) {
      const answersPath = "answers/" + qId;
      const idx = parseInt(qId.slice(1), 10);
      const q = QUESTIONS[idx] || {};
      const isDemo = !!q.isDemo;

      sessionRef(answersPath).once("value").then((snap) => {
        const answers = [];
        snap.forEach((child) => {
          const v = child.val() || {};
          answers.push({
            playerId: child.key,
            answer: v.answer,
            ts: v.ts || 0
          });
        });

        const correct = answers
          .filter((a) => a.answer === correctLetter)
          .sort((a, b) => a.ts - b.ts);

        if (!isDemo) {
          // Toplam cevap sayısı (istatistik için)
          answers.forEach(a => {
            sessionRef("players/" + a.playerId + "/totalAnswered").transaction(cur => (cur || 0) + 1);
          });

          // Doğru cevap sayısı + puan
          correct.forEach((a, idxPos) => {
            const points = Math.max(20 - idxPos, 1);
            const baseRef = sessionRef("players/" + a.playerId);
            baseRef.child("score").transaction((current) => (current || 0) + points);
            baseRef.child("totalCorrect").transaction((current) => (current || 0) + 1);
          });
        }

        // Açıklama: herkes için DB'ye yaz
        sessionRef("currentExplanation").set({
          qId: qId,
          index: idx + 1,
          correct: correctLetter,
          explanation: q.explanation || "",
          isDemo: isDemo,
          ts: Date.now()
        });

        // Son soruya geldiysek quiz'i bitir
        if (currentQuestionIndex === QUESTIONS.length - 1) {
          sessionRef("state").set({ status: "ended", index: currentQuestionIndex, finishedAt: Date.now() });
        }
      }).catch(err => {
        console.error("Puanlama hatası:", err);
      });
    }

    /*************** 6) KATILIMCI TARAFI ***************/
    let playerKey = null;
    let myNickname = "";
    let currentQuestion = null;
    let playerCountdownInterval = null;
    let playerQuestionEndTime = null;
    let hasAnsweredThisQuestion = false;
    let lastAnswerForQuestion = null;

    function initPlayer() {
      playerArea.classList.remove("hidden");
      modeInfo.textContent = "Mod: Katılımcı (telefon ekranı)";

      const joinStep = document.getElementById("joinStep");
      const playStep = document.getElementById("playStep");
      const finishedStep = document.getElementById("finishedStep");

      const nickInput = document.getElementById("nickInput");
      const joinBtn = document.getElementById("joinBtn");
      const joinMsg = document.getElementById("joinMsg");
      const helloPlayer = document.getElementById("helloPlayer");
      const playerQuestionTitle = document.getElementById("playerQuestionTitle");
      const playerOptions = document.getElementById("playerOptions");
      const playerTimer = document.getElementById("playerTimer");
      const answerBtn = document.getElementById("answerBtn");
      const answerMsg = document.getElementById("answerMsg");
      const playerScoreBody = document.getElementById("playerScoreBody");
      const playerQuestionMeta = document.getElementById("playerQuestionMeta");
      const playerQuestionBadge = document.getElementById("playerQuestionBadge");
      const playerExplanation = document.getElementById("playerExplanation");
      const playerQuestionImage = document.getElementById("playerQuestionImage");
      const summaryScore = document.getElementById("summaryScore");
      const summaryDetail = document.getElementById("summaryDetail");

      function handleResetOnPlayerSide() {
        localStorage.removeItem("ercQuizPlayerKey");
        playerKey = null;
        myNickname = "";
        currentQuestion = null;
        hasAnsweredThisQuestion = false;
        lastAnswerForQuestion = null;
        if (playerCountdownInterval) clearInterval(playerCountdownInterval);
        playerTimer.textContent = "";
        playerTimer.className = "timer-text";
        answerBtn.disabled = true;
        playerOptions.innerHTML = "";
        playerQuestionTitle.textContent = "Soru bekleniyor...";
        playerQuestionMeta.textContent = "";
        playerQuestionBadge.textContent = "Soru bekleniyor";
        helloPlayer.textContent = "";
        playerExplanation.textContent = "";
        playerQuestionImage.src = "";
        playerQuestionImage.classList.add("hidden");

        playStep.classList.add("hidden");
        finishedStep.classList.add("hidden");
        joinStep.classList.remove("hidden");

        joinMsg.textContent = "Oturum sıfırlandı. Yeni oturuma tekrar katılabilirsin.";
        joinMsg.className = "status-text info";
        nickInput.value = "";
      }

      sessionRef("players").on("value", (snap) => {
        const list = [];
        snap.forEach((child) => {
          const v = child.val() || {};
          list.push({
            nickname: v.nickname || "???",
            score: v.score || 0
          });
        });
        list.sort((a, b) => b.score - a.score);

        playerScoreBody.innerHTML = "";
        list.slice(0, 10).forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${idx + 1}</td><td>${p.nickname}</td><td>${p.score}</td>`;
          playerScoreBody.appendChild(tr);
        });
      });

      sessionRef("state").on("value", (snap) => {
        const st = snap.val();
        if (!st) return;
        if (st.status === "ended") {
          finishedStep.classList.remove("hidden");
          playerTimer.textContent = "";
          playerTimer.className = "timer-text";
          answerBtn.disabled = true;

          // Kişisel özet
          if (playerKey) {
            sessionRef("players/" + playerKey).once("value").then(s => {
              const v = s.val() || {};
              const score = v.score || 0;
              const totalCorrect = v.totalCorrect || 0;
              const totalAnswered = v.totalAnswered || 0;
              summaryScore.textContent = "Toplam puanın: " + score;
              if (totalAnswered > 0) {
                summaryDetail.textContent = "Doğru sayın: " + totalCorrect + " / " + totalAnswered + " (demo sorular hariç).";
              } else {
                summaryDetail.textContent = "Bu oturumda puanlanan soru cevaplamadın veya demo sorulardaydın.";
              }
            }).catch(() => {
              summaryScore.textContent = "";
              summaryDetail.textContent = "";
            });
          }
        } else if (st.status === "waiting") {
          // Eğitmen reset'e bastığında herkesi başa al
          handleResetOnPlayerSide();
        }
      });

      joinBtn.onclick = () => {
        const nick = (nickInput.value || "").trim();
        if (!nick) {
          joinMsg.textContent = "Lütfen bir nick gir.";
          joinMsg.className = "status-text error";
          return;
        }
        myNickname = nick;
        joinMsg.textContent = "Katılınıyor...";
        joinMsg.className = "status-text info";

        const storedKey = localStorage.getItem("ercQuizPlayerKey");
        if (storedKey) {
          playerKey = storedKey;
        } else {
          const newRef = sessionRef("players").push();
          playerKey = newRef.key;
          localStorage.setItem("ercQuizPlayerKey", playerKey);
        }

        sessionRef("players/" + playerKey).update({
          nickname: myNickname,
          score: 0,
          totalCorrect: 0,
          totalAnswered: 0
        }).then(() => {
          joinStep.classList.add("hidden");
          playStep.classList.remove("hidden");
          helloPlayer.textContent = "Hoş geldin, " + myNickname + ". Soru başlatıldığında süre işlemeye başlayacak.";
          helloPlayer.className = "status-text success";
        }).catch(err => {
          joinMsg.textContent = "Katılırken bir hata oluştu: " + err.message;
          joinMsg.className = "status-text error";
        });
      };

      // Soruyu dinle
      sessionRef("currentQuestion").on("value", (snap) => {
        const q = snap.val();
        if (!q) {
          currentQuestion = null;
          playerQuestionTitle.textContent = "Soru bekleniyor...";
          playerOptions.innerHTML = "";
          playerTimer.textContent = "";
          playerTimer.className = "timer-text";
          playerQuestionMeta.textContent = "";
          playerQuestionBadge.textContent = "Soru bekleniyor";
          playerExplanation.textContent = "";
          answerBtn.disabled = true;
          playerQuestionImage.src = "";
          playerQuestionImage.classList.add("hidden");
          return;
        }

        currentQuestion = q;
        hasAnsweredThisQuestion = false;
        lastAnswerForQuestion = null;
        answerMsg.textContent = "";
        answerMsg.className = "status-text";
        playerExplanation.textContent = "";

        const seconds = Math.round((q.timeLimitMs || DEFAULT_TIME_LIMIT_MS) / 1000);
        playerQuestionMeta.textContent = "Soru " + q.index + " / " + q.total + " • Süre: " + seconds + " sn";
        playerQuestionBadge.textContent = "Aktif";
        playerQuestionTitle.textContent = q.text || "";
        playerOptions.innerHTML = "";

        if (q.imageUrl) {
          playerQuestionImage.src = q.imageUrl;
          playerQuestionImage.classList.remove("hidden");
        } else {
          playerQuestionImage.src = "";
          playerQuestionImage.classList.add("hidden");
        }

        (q.options || []).forEach((opt, idx) => {
          const letter = String.fromCharCode(65 + idx);
          const id = "opt" + idx;
          const label = document.createElement("label");
          label.className = "option-label";
          label.htmlFor = id;
          label.innerHTML = `
            <input type="radio" name="answer" id="${id}" value="${letter}">
            <div class="option-card">
              <div class="option-letter">${letter}</div>
              <div class="option-text">${opt}</div>
            </div>
          `;
          playerOptions.appendChild(label);
        });

        if (playerCountdownInterval) clearInterval(playerCountdownInterval);
        const endTime = q.startTime + (q.timeLimitMs || DEFAULT_TIME_LIMIT_MS);
        playerQuestionEndTime = endTime;

        function playerTick() {
          const now = Date.now();
          const remaining = endTime - now;
          if (remaining <= 0) {
            playerTimer.textContent = "Süre doldu. Eğitmenin yeni olguyu başlatmasını bekle.";
            playerTimer.className = "timer-text";
            answerBtn.disabled = true;
            clearInterval(playerCountdownInterval);
          } else {
            const sec = Math.ceil(remaining / 1000);
            playerTimer.textContent = "Kalan süre: " + sec + " sn";
            playerTimer.className = "timer-text " + (sec <= 3 ? "timer-critical" : "timer-hot");
            if (!hasAnsweredThisQuestion) {
              answerBtn.disabled = false;
            }
          }
        }
        playerTick();
        playerCountdownInterval = setInterval(playerTick, 200);
      });

      // Açıklama dinleyicisi (kişisel "doğru/yanlış/cevap yok")
      sessionRef("currentExplanation").on("value", (snap) => {
        const ex = snap.val();
        if (!ex || !currentQuestion || ex.qId !== currentQuestion.qId) {
          return;
        }

        // Süre bitmiş, cevap butonu kapalı olsun
        answerBtn.disabled = true;

        const correctLetter = ex.correct;
        let correctText = "";
        if (currentQuestion.options && currentQuestion.options.length) {
          const idx = correctLetter ? (correctLetter.charCodeAt(0) - 65) : -1;
          if (idx >= 0 && idx < currentQuestion.options.length) {
            correctText = currentQuestion.options[idx];
          }
        }

        let baseText = "";
        if (lastAnswerForQuestion && lastAnswerForQuestion.qId === ex.qId) {
          if (lastAnswerForQuestion.value === correctLetter) {
            baseText = "Bu soruya zamanında cevap verdin: " + correctLetter + (correctText ? " – " + correctText : "") + ". Doğru!";
          } else {
            baseText = "Bu soruya cevap verdin ama yanlış: " + lastAnswerForQuestion.value +
              ". Doğru cevap: " + correctLetter + (correctText ? " – " + correctText : "") + ".";
          }
        } else {
          baseText = "Bu soruya zamanında cevap veremedin. Doğru cevap: " + correctLetter +
            (correctText ? " – " + correctText : "") + ".";
        }

        let fullText = "";
        if (ex.isDemo) {
          fullText += "[DEMO soru – puan yok] ";
        }
        fullText += baseText;
        if (ex.explanation) {
          fullText += " " + ex.explanation;
        }

        playerExplanation.textContent = fullText;
      });

      answerBtn.onclick = () => {
        if (!currentQuestion) return;
        if (hasAnsweredThisQuestion) return;
        if (!playerKey) {
          answerMsg.textContent = "Önce katılman gerekiyor.";
          answerMsg.className = "status-text error";
          return;
        }

        const now = Date.now();
        if (playerQuestionEndTime && now > playerQuestionEndTime) {
          answerMsg.textContent = "Süre doldu, cevap gönderilemedi. Bir sonraki olguyu bekle.";
          answerMsg.className = "status-text error";
          answerBtn.disabled = true;
          return;
        }

        const selected = document.querySelector('#playerOptions input[name="answer"]:checked');
        if (!selected) {
          answerMsg.textContent = "Lütfen bir seçenek seç.";
          answerMsg.className = "status-text error";
          return;
        }

        hasAnsweredThisQuestion = true;
        answerBtn.disabled = true;
        const answer = selected.value;
        const qId = currentQuestion.qId;
        lastAnswerForQuestion = { qId, value: answer };

        sessionRef("answers/" + qId + "/" + playerKey).set({
          answer: answer,
          ts: now
        }).then(() => {
          answerMsg.textContent = "Cevabın kaydedildi. Puanlama süre sonunda yapılacak.";
          answerMsg.className = "status-text success";
        }).catch(err => {
          answerMsg.textContent = "Cevap gönderilemedi: " + err.message;
          answerMsg.className = "status-text error";
        });
      };
    }

    /*************** 7) BAŞLAT ***************/
    function startApp() {
      loadQuestions().then(() => {
        initConnectionMonitor();
        if (IS_HOST) {
          hostArea.classList.remove("hidden");
          playerArea.classList.add("hidden");
          initHost();
        } else {
          playerArea.classList.remove("hidden");
          hostArea.classList.add("hidden");
          initPlayer();
        }
      });
    }

    // Script body sonunda olduğu için DOM hazır; direkt başlatabiliriz
    startApp();
  </script>
</body>
</html>

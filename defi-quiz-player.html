<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Defi Quiz – Katılımcı</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e2e8f0;
      --accent:#16a34a;
      --danger:#dc2626;
      --text:#0f172a;
      --muted:#475569;
      --heading:#0f172a;
      --radius-lg:18px;
      --radius-pill:999px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:10px;
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
      font-size:15px;
    }
    .app{max-width:520px;margin:0 auto;}

    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }
    .brand{
      font-size:1.02rem;
      font-weight:800;
      letter-spacing:.04em;
      color:var(--heading);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      padding:6px 10px;
      font-size:0.82rem;
      color:var(--muted);
      background:#eef2ff;
    }
    .pill-dot{
      width:7px;height:7px;border-radius:999px;background:#16a34a;
      box-shadow:0 0 10px rgba(34,197,94,0.6);
    }

    .card{
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:0 14px 26px rgba(15,23,42,0.12);
      padding:12px;
      margin-top:10px;
      position:relative;
      overflow:hidden;
    }
    .card::before{display:none;}
    .card-inner{position:relative;z-index:1;}

    .question-title{
      font-size:0.96rem;
      font-weight:600;
      color:var(--heading);
      margin-bottom:4px;
    }
    .question-body{
      font-size:0.9rem;
      color:var(--text);
      white-space:pre-wrap;
      margin-bottom:6px;
    }

    .input-row{
      display:flex;
      gap:6px;
      margin-top:6px;
    }
    input[type="text"]{
      flex:1;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      font-size:0.9rem;
      outline:none;
    }
    input::placeholder{color:var(--muted);}
    .btn-join{
      border-radius:var(--radius-pill);
      border:none;
      background:linear-gradient(90deg,#16a34a,#22c55e);
      color:#f8fafc;
      padding:10px 12px;
      font-size:0.86rem;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(22,163,74,0.25);
    }

    .option-list{ margin-top:4px; }
    .option-btn{
      width:100%;
      border-radius:14px;
      border:1px solid #e2e8f0;
      background:#f8fafc;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      font-size:0.9rem;
      color:var(--text);
      cursor:pointer;
      margin-bottom:6px;
      transition:all .15s ease-out;
      box-shadow:0 8px 18px rgba(15,23,42,0.08);
    }
    .option-btn.disabled{ opacity:0.55; cursor:default; }
    .option-main{ display:flex; gap:6px; align-items:flex-start; }
    .option-badge{
      width:20px;
      height:20px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.8rem;
      color:var(--muted);
      flex-shrink:0;
    }
    .option-text{ text-align:left; }
    .option-btn.selected{
      outline:2px solid #22c55e;
      outline-offset:1px;
      border-color:#22c55e;
    }
    .option-btn.correct{
      border-color:#22c55e;
      box-shadow:0 0 0 1px rgba(34,197,94,0.5);
    }
    .option-btn.correct .option-badge{
      border-color:#22c55e;
      color:#22c55e;
    }

    .timer-pill{
      border-radius:var(--radius-pill);
      border:1px solid #cbd5e1;
      padding:5px 10px;
      font-size:0.82rem;
      color:#0f172a;
      font-variant-numeric:tabular-nums;
      display:inline-block;
      margin-top:4px;
      background:#f1f5f9;
    }

    .feedback{
      margin-top:4px;
      font-size:0.8rem;
      color:var(--muted);
    }
    .feedback.ok{color:#22c55e;}
    .feedback.bad{color:var(--danger);}

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal.show{display:flex;}
    .modal-backdrop{
      position:absolute;
      inset:0;
      background:rgba(15,23,42,0.45);
    }
    .modal-card{
      position:relative;
      background:#fff;
      border-radius:18px;
      border:1px solid #e2e8f0;
      padding:14px;
      width:min(420px,90vw);
      box-shadow:0 18px 32px rgba(15,23,42,0.16);
    }
    .modal-title{
      font-size:0.92rem;
      font-weight:600;
      color:var(--heading);
      margin-bottom:4px;
    }
    .modal-body{
      font-size:0.85rem;
      color:var(--text);
      max-height:220px;
      overflow-y:auto;
      white-space:pre-wrap;
    }
    .btn-modal{
      margin-top:10px;
      border-radius:var(--radius-pill);
      border:none;
      padding:8px 14px;
      background:linear-gradient(90deg,#16a34a,#22c55e);
      color:#f8fafc;
      font-size:0.84rem;
      font-weight:700;
      cursor:pointer;
      display:inline-flex;
      margin-left:auto;
      box-shadow:0 10px 18px rgba(22,163,74,0.25);
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="top-bar">
      <div class="brand">Defi Quiz</div>
      <div class="pill">
        <span class="pill-dot"></span>
        Skorun: <span id="myScore">0</span> p
      </div>
    </header>

    <!-- Katıl kartı -->
    <section class="card" id="joinCard">
      <div class="card-inner">
        <div class="question-title">Katıl</div>
        <div class="question-body">
          Nickini yaz ve bağlan.
        </div>
        <div class="input-row">
          <input id="nicknameInput" type="text" maxlength="20" placeholder="Örn. ShockDoc" />
          <button id="joinBtn" class="btn-join">Katıl</button>
        </div>
        <div id="joinFeedback" class="feedback"></div>
      </div>
    </section>

    <!-- Quiz kartı -->
    <section class="card" id="quizCard" style="display:none;">
      <div class="card-inner">
        <div class="question-title" id="questionTitle">Bekleniyor</div>
        <div class="question-body" id="questionStem"></div>

        <div id="optionsList" class="option-list"></div>

        <span id="timerLabel" class="timer-pill">Süre: –</span>
        <div id="answerStatus" class="feedback">Bekleniyor</div>
      </div>
    </section>

    <!-- Bilgi kartı -->
    <section class="card">
      <div class="card-inner">
        <div class="question-title">Bilgi</div>
        <div class="feedback">
          Süre bitince yanıt verilebilir; puan yazmaz.
        </div>
      </div>
    </section>
  </div>

  <!-- Açıklama popup -->
  <div id="exModal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-card">
      <div class="modal-title" id="exModalTitle">Soru açıklaması</div>
      <div class="modal-body" id="exModalBody"></div>
      <button id="exModalClose" class="btn-modal">Tamam</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDzzwE5VHZAiP2k8P_iocDaq7uGm1zN1cE",
      authDomain: "defi-quiz.firebaseapp.com",
      databaseURL: "https://defi-quiz-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "defi-quiz",
      storageBucket: "defi-quiz.firebasestorage.app",
      messagingSenderId: "642741899462",
      appId: "1:642741899462:web:bcc787a87d0ec69c9b47c7",
      measurementId: "G-SY348RPCVZ"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    const db      = firebase.database();
    const rootRef = db.ref("defiQuiz");
    const CONFIG_URL = "defi-quiz-config.json";

    let CONFIG       = null;
    let QUESTIONS    = [];
    let configLoaded = false;

    let sessionToken   = null;
    let triedAutoJoin  = false;
    let playerId       = null;
    let nickname       = null;

    let currentIndex      = null;
    let quizStarted       = false;
    let currentQuestionId = null;
    let questionActive    = false;
    let reveal            = false;

    let answeredQuestions = {};
    let answerOutcomes    = {};
    let selectedChoiceIdx = null;

    let timerInterval     = null;

    // server-synced timer fields
    let serverOffset      = 0;
    let timerStartedAt    = null;
    let timerDurationSec  = null;
    let timerBoundQid     = null;

    // DOM
    const joinCard      = document.getElementById("joinCard");
    const quizCard      = document.getElementById("quizCard");
    const nicknameInput = document.getElementById("nicknameInput");
    const joinBtn       = document.getElementById("joinBtn");
    const joinFeedback  = document.getElementById("joinFeedback");

    const questionTitleEl = document.getElementById("questionTitle");
    const questionStemEl  = document.getElementById("questionStem");
    const optionsListEl   = document.getElementById("optionsList");
    const timerLabel      = document.getElementById("timerLabel");
    const answerStatus    = document.getElementById("answerStatus");
    const myScoreEl       = document.getElementById("myScore");

    const exModal       = document.getElementById("exModal");
    const exModalTitle  = document.getElementById("exModalTitle");
    const exModalBody   = document.getElementById("exModalBody");
    const exModalClose  = document.getElementById("exModalClose");

    function safeQuestion(idx){
      if(!QUESTIONS.length) return null;
      if(idx<0) idx=0;
      if(idx>=QUESTIONS.length) idx=QUESTIONS.length-1;
      return QUESTIONS[idx];
    }

    function attachScoreListener(){
      if(!playerId) return;
      rootRef.child("players").child(playerId).child("score")
        .on("value",snap=>{
          myScoreEl.textContent = snap.val() || 0;
        });
    }

    function stopTimer(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function computeRemainingSec(){
      if(!timerStartedAt || !timerDurationSec) return null;
      const now = Date.now() + serverOffset;
      const end = timerStartedAt + (timerDurationSec * 1000);
      return Math.max(0, Math.ceil((end - now) / 1000));
    }

    function syncTimerLoop(){
      stopTimer();

      if(!quizStarted || !currentQuestionId){
        timerLabel.textContent="Süre: –";
        return;
      }

      // Timer is shown even if questionActive=false (0sn), because late answers allowed.
      if(!timerStartedAt || !timerDurationSec){
        timerLabel.textContent="Süre: –";
        return;
      }

      timerBoundQid = currentQuestionId;

      const tick = ()=>{
        if(timerBoundQid && currentQuestionId && timerBoundQid !== currentQuestionId){
          stopTimer();
          return;
        }
        const rem = computeRemainingSec();
        if(rem === null){
          timerLabel.textContent="Süre: –";
          return;
        }
        timerLabel.textContent="Süre: " + rem + " sn";
        if(rem <= 0){
          timerLabel.textContent="Süre: 0 sn";
        }
        updateButtonsState();
      };

      tick();
      timerInterval = setInterval(tick, 250);
    }

    function updateButtonsState(){
      const canClick = configLoaded && quizStarted && currentQuestionId && playerId && !reveal;
      const already  = currentQuestionId && answeredQuestions[currentQuestionId];
      const disabled = !canClick || already;

      const children = optionsListEl.querySelectorAll(".option-btn");
      children.forEach(btn=>{
        if(disabled) btn.classList.add("disabled");
        else btn.classList.remove("disabled");
      });
    }

    function renderWaiting(){
      questionTitleEl.textContent = "Bekleniyor";
      questionStemEl.textContent  = "—";
      optionsListEl.innerHTML     = "";
      timerLabel.textContent      = "Süre: –";
      answerStatus.textContent    = "Bekleniyor";
      answerStatus.className      = "feedback";
      updateButtonsState();
    }

    function renderQuestion(){
      if(!configLoaded){
        questionTitleEl.textContent = "Yükleniyor";
        questionStemEl.textContent  = "";
        optionsListEl.innerHTML     = "";
        return;
      }

      if(!quizStarted){
        renderWaiting();
        return;
      }

      if(currentIndex==null || !currentQuestionId){
        questionTitleEl.textContent = "Bekleniyor";
        questionStemEl.textContent  = "—";
        optionsListEl.innerHTML     = "";
        timerLabel.textContent      = "Süre: –";
        answerStatus.textContent    = "Bekleniyor";
        answerStatus.className      = "feedback";
        updateButtonsState();
        return;
      }

      const q = safeQuestion(currentIndex);
      if(!q){
        questionTitleEl.textContent = "Soru yok";
        questionStemEl.textContent  = "";
        optionsListEl.innerHTML     = "";
        updateButtonsState();
        return;
      }

      questionTitleEl.textContent = q.title || ("Soru " + (currentIndex+1));
      questionStemEl.textContent  = q.stem  || "";

      optionsListEl.innerHTML = "";
      (q.options || []).forEach((opt,idx)=>{
        const btn  = document.createElement("button");
        btn.type   = "button";
        btn.className = "option-btn";
        if(reveal && idx === q.correctIndex) btn.classList.add("correct");
        if(selectedChoiceIdx === idx) btn.classList.add("selected");

        const main = document.createElement("div");
        main.className = "option-main";

        const badge = document.createElement("div");
        badge.className = "option-badge";
        badge.textContent = String.fromCharCode(65 + idx);

        const text = document.createElement("div");
        text.className = "option-text";
        text.textContent = opt;

        main.appendChild(badge);
        main.appendChild(text);
        btn.appendChild(main);

        btn.addEventListener("click",()=> sendAnswer(idx));
        optionsListEl.appendChild(btn);
      });

      const existingSummary = currentQuestionId ? answerOutcomes[currentQuestionId] : null;
      const rem = computeRemainingSec();

      if(existingSummary){
        answerStatus.textContent = existingSummary.text;
        answerStatus.className   = existingSummary.className;
      }else if(reveal){
        answerStatus.textContent = "Yanıt";
        answerStatus.className   = "feedback";
      }else if(answeredQuestions[currentQuestionId]){
        answerStatus.textContent = "Yanıtlandı";
        answerStatus.className   = "feedback";
      }else if(rem !== null && rem <= 0){
        answerStatus.textContent = "Süre bitti (puan yok)";
        answerStatus.className   = "feedback";
      }else if(questionActive){
        answerStatus.textContent = "Yanıtla";
        answerStatus.className   = "feedback";
      }else{
        answerStatus.textContent = "Kapalı";
        answerStatus.className   = "feedback";
      }

      updateButtonsState();
    }

    function computePoints(orderPosition){
      if(orderPosition<=0) return 0;
      if(orderPosition===1) return 20;
      if(orderPosition===2) return 19;
      if(orderPosition===3) return 18;
      if(orderPosition===4) return 17;
      if(orderPosition===5) return 16;
      return 15;
    }

    function openExplanationModal(isCorrect, q){
      if(!q) return;
      exModalTitle.textContent = isCorrect ? "Doğru" : "Açıklama";

      let body = "";
      if(typeof q.correctIndex === "number" && q.options && q.options[q.correctIndex]){
        const letter = String.fromCharCode(65 + q.correctIndex);
        body += "Doğru: " + letter + ") " + q.options[q.correctIndex] + "\n\n";
      }
      if(q.explanation) body += q.explanation;

      exModalBody.textContent = body;
      exModal.classList.add("show");
    }
    function closeExplanationModal(){ exModal.classList.remove("show"); }
    exModalClose.addEventListener("click", closeExplanationModal);
    exModal.addEventListener("click", e=>{ if(e.target === exModal) closeExplanationModal(); });

    function sendAnswer(choiceIndex){
      if(!playerId || !configLoaded || currentIndex==null || !currentQuestionId) return;
      if(!quizStarted) return;
      if(reveal) return;
      if(answeredQuestions[currentQuestionId]) return;

      const q = safeQuestion(currentIndex);
      if(!q) return;

      const children = optionsListEl.querySelectorAll(".option-btn");
      children.forEach(btn=>btn.classList.remove("selected"));
      if(children[choiceIndex]) children[choiceIndex].classList.add("selected");
      selectedChoiceIdx = choiceIndex;

      answeredQuestions[currentQuestionId] = true;
      updateButtonsState();

      const isCorrect = (choiceIndex === q.correctIndex);
      const rem = computeRemainingSec();
      const late = (!questionActive) || (rem !== null && rem <= 0);

      const qIdStr = String(currentQuestionId);
      const answersRef   = rootRef.child("answers").child(qIdStr);
      const playerAnsRef = answersRef.child(playerId);

      // Late (or closed) answers: record, but no ordering and no score changes.
      if(late){
        playerAnsRef.set({
          nickname: nickname || "Anonim",
          choiceIndex: choiceIndex,
          correct: !!isCorrect,
          late: true,
          points: 0,
          ts: Date.now()
        });

        const summary = isCorrect
          ? { text: "Doğru (puan yok)", className: "feedback ok", isCorrect: true }
          : { text: "Yanlış (puan yok)", className: "feedback bad", isCorrect: false };

        answerOutcomes[currentQuestionId] = summary;
        answerStatus.textContent = summary.text;
        answerStatus.className   = summary.className;
        return;
      }

      // On-time answers:
      if(!isCorrect){
        playerAnsRef.set({
          nickname: nickname || "Anonim",
          choiceIndex: choiceIndex,
          correct: false,
          late: false,
          points: 0,
          ts: Date.now()
        });
        const summary = { text: "Yanlış", className: "feedback bad", isCorrect: false };
        answerOutcomes[currentQuestionId] = summary;
        answerStatus.textContent = summary.text;
        answerStatus.className   = summary.className;
        return;
      }

      const orderRef = rootRef.child("answerOrder").child(qIdStr);
      orderRef.transaction(cur => (cur || 0) + 1, (err, committed, snap)=>{
        if(!committed || !snap) return;
        const pos = snap.val();
        const pts = computePoints(pos);

        playerAnsRef.set({
          nickname: nickname || "Anonim",
          choiceIndex: choiceIndex,
          correct: true,
          late: false,
          position: pos,
          points: pts,
          ts: Date.now()
        });

        const scoreRef = rootRef.child("players").child(playerId).child("score");
        scoreRef.transaction(cur => (cur || 0) + pts);

        const summary = { text: "Doğru • " + pts + "p", className: "feedback ok", isCorrect: true };
        answerOutcomes[currentQuestionId] = summary;
        answerStatus.textContent = summary.text;
        answerStatus.className   = summary.className;
      });
    }

    function joinSession(){
      const nick = nicknameInput.value.trim();
      if(!nick){
        joinFeedback.textContent = "Nick zorunlu.";
        return;
      }
      nickname = nick;
      if(!playerId) playerId = "p_" + Math.random().toString(36).substr(2,9);

      const playerRef = rootRef.child("players").child(playerId);
      playerRef.child("score").once("value").then(s=>{
        if(!s.exists()) playerRef.update({ nickname:nickname, score:0 });
        else playerRef.update({ nickname:nickname });
      }).catch(()=> playerRef.update({ nickname:nickname, score:0 }));

      if(sessionToken) localStorage.setItem("defiQuizSessionToken", String(sessionToken));
      else localStorage.removeItem("defiQuizSessionToken");

      localStorage.setItem("defiQuizPlayerId", playerId);
      localStorage.setItem("defiQuizNickname", nickname);

      joinCard.style.display = "none";
      quizCard.style.display = "block";
      joinFeedback.textContent = "";

      attachScoreListener();
      renderQuestion();
      updateButtonsState();
      syncTimerLoop();
    }
    joinBtn.addEventListener("click", joinSession);
    nicknameInput.addEventListener("keydown", e=>{ if(e.key==="Enter") joinSession(); });

    function tryAutoJoin(){
      if(!sessionToken || triedAutoJoin) return;
      triedAutoJoin = true;

      const storedSession = localStorage.getItem("defiQuizSessionToken");
      const storedId      = localStorage.getItem("defiQuizPlayerId");
      const storedNick    = localStorage.getItem("defiQuizNickname");

      if(storedId && storedNick && storedNick.trim() && storedNick!=="Anonim" &&
         storedSession && String(storedSession)===String(sessionToken)){
        playerId = storedId;
        nickname = storedNick;
        joinCard.style.display = "none";
        quizCard.style.display = "block";
        attachScoreListener();
        renderQuestion();
        updateButtonsState();
        syncTimerLoop();
      }else{
        joinCard.style.display = "block";
        quizCard.style.display = "none";
      }
    }

    function handleSessionTokenChange(newToken){
      if(!newToken){
        sessionToken = null;
        return;
      }
      if(sessionToken && sessionToken!==newToken){
        // session reset
        playerId = null;
        nickname = null;
        answeredQuestions = {};
        answerOutcomes    = {};
        selectedChoiceIdx = null;
        stopTimer();
        timerLabel.textContent = "Süre: –";
        myScoreEl.textContent  = "0";

        quizStarted = false;
        currentIndex = null;
        currentQuestionId = null;
        questionActive = false;
        reveal = false;

        localStorage.removeItem("defiQuizPlayerId");
        localStorage.removeItem("defiQuizNickname");
        localStorage.removeItem("defiQuizSessionToken");

        joinCard.style.display = "block";
        quizCard.style.display = "none";
        joinFeedback.textContent = "Oturum yenilendi.";
      }
      sessionToken = newToken;
      tryAutoJoin();
    }

    function attachDbListeners(){
      firebase.database().ref(".info/serverTimeOffset").on("value", snap=>{
        serverOffset = snap.val() || 0;
        syncTimerLoop();
      });

      rootRef.child("timerStartedAt").on("value", snap=>{
        timerStartedAt = snap.val() || null;
        syncTimerLoop();
      });
      rootRef.child("timerDurationSec").on("value", snap=>{
        timerDurationSec = snap.val() || null;
        syncTimerLoop();
      });

      rootRef.child("quizStarted").on("value", snap=>{
        quizStarted = !!snap.val();
        renderQuestion();
        updateButtonsState();
        syncTimerLoop();
      });

      rootRef.child("sessionToken").on("value",snap=>{
        const val = snap.val();
        if(val) handleSessionTokenChange(val);
      });

      rootRef.child("currentQuestionIndex").on("value",snap=>{
        const idx = snap.val();
        if(idx === null || idx === undefined) return;
        currentIndex = idx;
        renderQuestion();
      });

      rootRef.child("currentQuestionId").on("value",snap=>{
        const newId = snap.val();
        if(newId !== currentQuestionId){
          currentQuestionId = newId;
          stopTimer();
          selectedChoiceIdx = null;
          renderQuestion();
          syncTimerLoop();
        }
      });

      rootRef.child("questionActive").on("value",snap=>{
        questionActive = !!snap.val();
        renderQuestion();
        updateButtonsState();
        syncTimerLoop();
      });

      rootRef.child("reveal").on("value",snap=>{
        const prev = reveal;
        reveal = !!snap.val();

        renderQuestion();
        updateButtonsState();

        if(reveal && !prev && configLoaded && quizStarted && currentIndex!=null){
          const q = safeQuestion(currentIndex);
          const info = currentQuestionId ? answerOutcomes[currentQuestionId] : null;
          if(q) openExplanationModal(!!(info && info.isCorrect), q);
        }
      });
    }

    async function loadConfig(){
      try{
        const res = await fetch(CONFIG_URL,{cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        CONFIG    = await res.json();
        QUESTIONS = (CONFIG.questions || []).slice();
        configLoaded = true;
        attachDbListeners();
        renderQuestion();
      }catch(e){
        console.error(e);
        questionTitleEl.textContent = "Config yok";
        questionStemEl.textContent  = "defi-quiz-config.json aynı klasörde olmalı.";
      }
    }

    loadConfig();
  </script>
</body>
</html>

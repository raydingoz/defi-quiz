<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Defi Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e2e8f0;
      --accent:#16a34a;
      --danger:#dc2626;
      --text:#0f172a;
      --muted:#475569;
      --heading:#0f172a;
      --radius-lg:20px;
      --radius-pill:999px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:18px;
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
      font-size:18px;
      line-height:1.6;
    }
    .app{max-width:1400px;margin:0 auto;}

    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    .brand{font-size:1.3rem;font-weight:800;letter-spacing:.04em;color:var(--heading);}
    .top-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      padding:10px 16px;
      font-size:1rem;
      color:var(--muted);
      background:#eef2ff;
    }
    .dot-live{
      width:9px;height:9px;border-radius:999px;
      background:var(--danger);
      box-shadow:0 0 12px rgba(239,68,68,0.9);
    }
    .small{font-size:0.78rem;}

    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.7fr) minmax(0,1fr);
      gap:16px;
    }
    @media(max-width:900px){
      .layout{grid-template-columns:minmax(0,1fr);}
    }

    .card{
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:0 16px 34px rgba(15,23,42,0.12);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .card::before{display:none;}
    .card-inner{position:relative;z-index:1;}

    .section-title{
      font-size:1.05rem;
      color:var(--muted);
      margin-bottom:8px;
      letter-spacing:.06em;
    }
    .question-title{
      font-size:1.5rem;
      font-weight:700;
      color:var(--heading);
      margin-bottom:8px;
    }
    .question-body{font-size:1.1rem;color:var(--text);white-space:pre-wrap;margin-bottom:10px;}

    .progress-wrap{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .progress-label{
      font-size:1rem;
      color:var(--muted);
    }
    .progress-track{
      flex:1;
      height:8px;
      border-radius:999px;
      background:linear-gradient(90deg,#e5e7eb,#cbd5e1);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.7);
      overflow:hidden;
    }
    .progress-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#f97373,#fbbf24);
      transition:width .3s ease-out;
      box-shadow:0 0 14px rgba(251,191,36,0.5);
    }

    .option-list{
      margin-top:6px;
    }
    .option-row{
      border-radius:14px;
      border:1px solid #e2e8f0;
      background:#f8fafc;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      font-size:1.05rem;
      margin-bottom:6px;
    }
    .option-label{
      display:flex;
      gap:6px;
      align-items:flex-start;
    }
    .option-badge{
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px solid #4b5563;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.92rem;
      color:var(--muted);
      flex-shrink:0;
    }
    .option-text{
      color:var(--text);
    }
    .option-row.correct{
      border-color:#22c55e;
      box-shadow:0 0 0 1px rgba(34,197,94,0.5);
    }
    .option-row.correct .option-badge{
      border-color:#22c55e;
      color:#22c55e;
    }

    .timer-status-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
      gap:8px;
    }
    .timer-pill{
      border-radius:var(--radius-pill);
      border:1px solid #cbd5e1;
      font-size:1rem;
      padding:8px 14px;
      color:#0f172a;
      font-variant-numeric:tabular-nums;
      background:#f1f5f9;
    }

    .meta-line{
      font-size:1rem;
      color:var(--muted);
    }

    .reveal-box{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px dashed #cbd5e1;
      background:#f8fafc;
    }
    .reveal-title{
      font-weight:700;
      color:var(--heading);
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .reveal-body{font-size:1.1rem;color:var(--text);white-space:pre-wrap;}

    .btn-row{margin-top:12px;display:flex;gap:10px;flex-wrap:nowrap;align-items:center;}
    .btn-row .btn{flex:1;justify-content:center;min-width:0;}
    @media(max-width:1100px){.btn-row{flex-wrap:wrap;}}
    .btn{
      border-radius:14px;
      border:1px solid #e2e8f0;
      background:#fff;
      color:var(--text);
      font-size:1rem;
      font-weight:600;
      padding:10px 14px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      cursor:pointer;
      transition:all .15s ease-out;
      box-shadow:0 8px 18px rgba(15,23,42,0.08);
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 12px 22px rgba(15,23,42,0.12);}
    .btn-main{
      background:linear-gradient(90deg,#16a34a,#22c55e);
      border:none;
      color:#f8fafc;
      box-shadow:0 10px 24px rgba(22,163,74,0.35);
    }
    .btn-ghost{
      background:#f8fafc;
      color:#0f172a;
      border-color:#e2e8f0;
    }
    .btn[disabled]{opacity:0.45;cursor:default;box-shadow:none;}
    .btn-danger{color:var(--danger);border-color:#e2e8f0;background:#fff;}

    .podium{display:none;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;align-items:flex-end;margin-top:8px;}
    .podium-card{position:relative;border-radius:16px;border:1px solid #e2e8f0;padding:10px 10px 14px;display:flex;flex-direction:column;justify-content:flex-end;align-items:center;gap:6px;text-align:center;background:#ffffff;box-shadow:0 12px 26px rgba(15,23,42,0.12);min-height:120px;}
    .podium-card::after{content:"";position:absolute;left:50%;bottom:8px;transform:translateX(-50%);width:70%;height:7px;border-radius:999px;background:rgba(15,23,42,0.06);}
    .podium-card .place{font-weight:800;font-size:0.95rem;letter-spacing:.02em;}
    .podium-card .name{font-weight:700;color:#0f172a;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .podium-card .score{font-weight:800;color:#0f172a;}
    .podium-card.second{order:1;height:150px;background:linear-gradient(180deg,#eceff4,#d5dae0);border-color:#cbd5e1;}
    .podium-card.second .place{color:#6b7280;}
    .podium-card.first{order:2;height:180px;background:linear-gradient(180deg,#fef9c3,#fef08a);border-color:#fbbf24;box-shadow:0 16px 32px rgba(251,191,36,0.24);}
    .podium-card.first .place{color:#b45309;}
    .podium-card.third{order:3;height:135px;background:linear-gradient(180deg,#fed7aa,#f4b08a);border-color:#f59e0b;}
    .podium-card.third .place{color:#92400e;}
    .score-list{margin-top:10px;font-size:1rem;max-height:360px;overflow-y:auto;}
    .score-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed #e2e8f0;gap:8px;}
    .score-row .label{display:flex;align-items:center;gap:8px;max-width:220px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
    .score-row .medal{font-size:1.05rem;}
    .score-row .name{flex:1;overflow:hidden;text-overflow:ellipsis;}
    .score-row .score{font-weight:700;color:#0f172a;}

    .qr-cta{margin-top:10px;display:flex;gap:10px;align-items:center;}

    .qr-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999;}
    .qr-modal.show{display:flex;}
    .qr-card{background:#fff;border-radius:20px;padding:18px;box-shadow:0 20px 48px rgba(0,0,0,0.28);max-width:520px;text-align:center;}
    #qrcodeQuizLarge{width:420px;height:420px;margin:0 auto;}
    .qr-link{margin-top:8px;font-weight:700;color:#0f172a;word-break:break-all;}
    .modal-close{margin-top:12px;border:none;background:#0f172a;color:#e2e8f0;padding:12px 16px;border-radius:14px;font-weight:800;cursor:pointer;}

    .reveal-modal{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:9998;}
    .reveal-modal.show{display:flex;}
    .reveal-modal .modal-card{background:#ffffff;border-radius:20px;padding:20px;max-width:860px;width:90%;box-shadow:0 22px 50px rgba(0,0,0,0.28);}
    .reveal-modal .modal-title{font-size:1.3rem;font-weight:800;margin-bottom:10px;color:var(--heading);}
    .reveal-modal .modal-body{font-size:1.15rem;line-height:1.8;color:var(--text);white-space:pre-wrap;}
  </style>
</head>
<body>
  <div class="app">
    <header class="top-bar">
      <div class="brand">Defi Quiz</div>
      <div class="top-pill">
        <span class="dot-live"></span>
        <span>Defibrilasyon / KV Quiz</span>
        <span id="sessionLabel" class="small"></span>
      </div>
    </header>

    <main class="layout">
      <!-- SOL: Soru -->
      <section class="card">
        <div class="card-inner">
          <div class="section-title">Soru</div>

          <div class="progress-wrap">
            <div class="progress-label" id="progressLabel">Soru ‚Äì / ‚Äì</div>
            <div class="progress-track">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>

          <div class="question-title" id="questionTitle">Soru ba≈ülƒ±ƒüƒ±</div>
          <div class="question-body" id="questionStem">
            Config y√ºkleniyor (defi-quiz-config.json)‚Ä¶
          </div>

          <div id="optionsList" class="option-list"></div>

          <div class="timer-status-row">
            <span class="timer-pill" id="timerLabel">S√ºre: ‚Äì</span>
            <span class="meta-line" id="statusLine">
              Hazƒ±rsan s√ºreyi ba≈ülat, odak ekranda kalsƒ±n.
            </span>
          </div>

          <div class="btn-row">
            <button id="btnPrev" class="btn btn-ghost">‚üµ √ñnceki</button>
            <button id="btnNext" class="btn btn-ghost">Sonraki ‚ü∂</button>
            <button id="btnStart" class="btn btn-main">‚ñ∂ S√ºreyi ba≈ülat</button>
            <button id="btnReveal" class="btn btn-ghost">‚úÖ Yanƒ±tƒ± g√∂ster</button>
          </div>

          <div class="reveal-box" id="revealBox" style="display:none;">
            <div class="reveal-title" id="revealTitle">Doƒüru yanƒ±t</div>
            <div class="reveal-body" id="revealBody">A√ßƒ±klama y√ºklenecek.</div>
          </div>
        </div>
      </section>

      <!-- SAƒû: Skor & QR butonu -->
      <aside class="card">
        <div class="card-inner">
          <div class="section-title">Skor Tablosu</div>
          <div class="meta-line" style="margin-top:4px;">
            Katƒ±lƒ±mcƒ±: <span id="playerCount">0</span>
          </div>
          <div id="podium" class="podium"></div>
          <div id="scoreList" class="score-list"></div>

          <div class="qr-cta">
            <button id="btnShowQr" class="btn btn-ghost" style="flex:1;">
              üì± Katƒ±lƒ±m QR'ƒ±nƒ± G√∂ster
            </button>
            <button id="btnResetSession" class="btn btn-danger small">
              üîÅ Sƒ±fƒ±rla
            </button>
          </div>
          <div class="meta-line small" style="margin-top:6px;">
            QR a√ßƒ±lƒ±≈üƒ± ba≈üta otomatik g√∂sterilir; gerektiƒüinde butondan a√ßabilirsiniz.
          </div>
        </div>
      </aside>
    </main>
  </div>

  <div class="qr-modal" id="qrModal">
    <div class="qr-card">
      <div id="qrcodeQuizLarge"></div>
      <div class="qr-link" id="playerUrlText"></div>
      <button class="modal-close" id="qrModalClose">Kapat</button>
    </div>
  </div>

  <div class="reveal-modal" id="revealModal">
    <div class="modal-card">
      <div class="modal-title" id="revealModalTitle">Doƒüru yanƒ±t</div>
      <div class="modal-body" id="revealModalBody">A√ßƒ±klama y√ºklenecek.</div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDzzwE5VHZAiP2k8P_iocDaq7uGm1zN1cE",
      authDomain: "defi-quiz.firebaseapp.com",
      databaseURL: "https://defi-quiz-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "defi-quiz",
      storageBucket: "defi-quiz.firebasestorage.app",
      messagingSenderId: "642741899462",
      appId: "1:642741899462:web:bcc787a87d0ec69c9b47c7",
      measurementId: "G-SY348RPCVZ"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db      = firebase.database();
    const rootRef = db.ref("defiQuiz");

    const CONFIG_URL = "defi-quiz-config.json";

    let CONFIG       = null;
    let QUESTIONS    = [];
    let TOTAL_Q      = 0;
    let configLoaded = false;

    let sessionToken      = null;
    let currentIndex      = 0;
    let currentQuestionId = null;
    let questionActive    = false;
    let reveal            = false;

    let timerInterval = null;
    let timerRemaining = 0;

    // DOM
    const questionTitleEl = document.getElementById("questionTitle");
    const questionStemEl  = document.getElementById("questionStem");
    const optionsListEl   = document.getElementById("optionsList");
    const timerLabel      = document.getElementById("timerLabel");
    const statusLine      = document.getElementById("statusLine");

    const btnPrev         = document.getElementById("btnPrev");
    const btnNext         = document.getElementById("btnNext");
    const btnStart        = document.getElementById("btnStart");
    const btnReveal       = document.getElementById("btnReveal");
    const btnReset        = document.getElementById("btnResetSession");

    const sessionLabel    = document.getElementById("sessionLabel");
    const playerCountEl   = document.getElementById("playerCount");
    const podiumEl        = document.getElementById("podium");
    const scoreListEl     = document.getElementById("scoreList");
    const playerUrlText   = document.getElementById("playerUrlText");
    const btnShowQr       = document.getElementById("btnShowQr");
    const qrModal         = document.getElementById("qrModal");
    const qrModalClose    = document.getElementById("qrModalClose");
    const qrLargeBox      = document.getElementById("qrcodeQuizLarge");

    const revealModal     = document.getElementById("revealModal");
    const revealModalTitle= document.getElementById("revealModalTitle");
    const revealModalBody = document.getElementById("revealModalBody");

    const progressLabel   = document.getElementById("progressLabel");
    const progressFill    = document.getElementById("progressFill");

    const revealBox       = document.getElementById("revealBox");
    const revealTitle     = document.getElementById("revealTitle");
    const revealBody      = document.getElementById("revealBody");

    let playerUrl         = "";
    let qrModalShown      = false;
    let revealModalDismissed = false;

    function safeQuestion(idx){
      if(!QUESTIONS.length) return null;
      if(idx<0) idx=0;
      if(idx>=QUESTIONS.length) idx=QUESTIONS.length-1;
      return QUESTIONS[idx];
    }

    function stopTimer(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval=null;
      }
    }

    function startTimerForCurrent(){
      stopTimer();
      const q = safeQuestion(currentIndex);
      if(!q){
        timerLabel.textContent="S√ºre: ‚Äì";
        return;
      }
      timerRemaining = q.timeLimitSec || 30;
      timerLabel.textContent = "S√ºre: "+timerRemaining+" sn";
      timerInterval = setInterval(()=>{
        timerRemaining -= 1;
        if(timerRemaining <= 0){
          stopTimer();
          timerLabel.textContent="S√ºre: 0 sn";
          rootRef.update({ questionActive:false });
        }else{
          timerLabel.textContent = "S√ºre: "+timerRemaining+" sn";
        }
      },1000);
    }

    function updateProgress(){
      if(!TOTAL_Q || currentIndex==null){
        progressLabel.textContent = "Soru ‚Äì / ‚Äì";
        progressFill.style.width  = "0%";
        return;
      }
      const idx = currentIndex + 1;
      progressLabel.textContent = "Soru " + idx + " / " + TOTAL_Q;
      const pct = Math.max(0, Math.min(1, idx / TOTAL_Q));
      progressFill.style.width = (pct * 100).toFixed(1) + "%";
    }

    function formatCorrectAnswer(q){
      if(!q) return "Doƒüru yanƒ±t";
      if(typeof q.correctIndex === "number" && q.options && q.options[q.correctIndex]){
        const letter = String.fromCharCode(65 + q.correctIndex);
        return letter + ") " + q.options[q.correctIndex];
      }
      return "Doƒüru yanƒ±t";
    }

    function renderRevealBox(){
      const q = safeQuestion(currentIndex);
      if(!q || !currentQuestionId || !reveal){
        revealBox.style.display = "none";
        hideRevealModal(true);
        return;
      }

      revealTitle.textContent = formatCorrectAnswer(q);
      revealBody.textContent  = q.explanation || "A√ßƒ±klama hen√ºz eklenmemi≈ü.";
      revealBox.style.display = "block";
      showRevealModal();
    }

    function renderQuestion(){
      if(!configLoaded) return;
      const q = safeQuestion(currentIndex);
      if(!q){
        questionTitleEl.textContent = "Soru yok";
        questionStemEl.textContent  = "";
        optionsListEl.innerHTML     = "";
        return;
      }

      questionTitleEl.textContent = q.title || ("Soru " + (currentIndex+1));
      questionStemEl.textContent  = q.stem  || "";

      optionsListEl.innerHTML = "";
      (q.options || []).forEach((opt,idx)=>{
        const row = document.createElement("div");
        row.className = "option-row";
        if(reveal && idx === q.correctIndex){
          row.classList.add("correct");
        }
        const left = document.createElement("div");
        left.className = "option-label";

        const badge = document.createElement("div");
        badge.className = "option-badge";
        badge.textContent = String.fromCharCode(65 + idx);

        const text = document.createElement("div");
        text.className = "option-text";
        text.textContent = opt;

        left.appendChild(badge);
        left.appendChild(text);

        row.appendChild(left);
        optionsListEl.appendChild(row);
      });

      if(!currentQuestionId){
        statusLine.textContent = "S√ºre otomatik ba≈ülayacak (30 sn).";
      }else if(!questionActive && !reveal){
        statusLine.textContent = "Pasif. Aynƒ± soruyu ya da yenisini ba≈ülat.";
      }else if(questionActive){
        statusLine.textContent = "Soru a√ßƒ±k, yanƒ±tlar geliyor.";
      }else if(reveal){
        statusLine.textContent = "Doƒüru yanƒ±t ekranda.";
      }

      renderRevealBox();
      updateProgress();
      autoStartIfIdle();
    }

    function initQR(){
      try{
        let href = window.location.href;
        playerUrl = href.replace(/defi-quiz-host(\.html)?/,"defi-quiz-player.html");
        playerUrlText.textContent = playerUrl;
        renderQrModal();
        if(!qrModalShown){
          qrModalShown = true;
          setTimeout(()=>openQrModal(true), 200);
        }
      }catch(e){console.error(e);}  
    }
    initQR();

    // Butonlar
    btnPrev.addEventListener("click",()=>{
      if(!configLoaded) return;
      currentIndex = Math.max(0, currentIndex-1);
      currentQuestionId = null;
      questionActive = false;
      reveal = false;
      stopTimer();
      timerRemaining = 0;
      timerLabel.textContent = "S√ºre: ‚Äì";
      rootRef.update({
        currentQuestionIndex: currentIndex,
        currentQuestionId: null,
        questionActive: false,
        reveal: false
      });
      renderQuestion();
    });

    btnNext.addEventListener("click",()=>{
      if(!configLoaded) return;
      currentIndex = Math.min(TOTAL_Q-1, currentIndex+1);
      currentQuestionId = null;
      questionActive = false;
      reveal = false;
      stopTimer();
      timerRemaining = 0;
      timerLabel.textContent = "S√ºre: ‚Äì";
      rootRef.update({
        currentQuestionIndex: currentIndex,
        currentQuestionId: null,
        questionActive: false,
        reveal: false
      });
      renderQuestion();
    });

    function startQuestion(auto=false){
      if(!configLoaded) return;
      const q = safeQuestion(currentIndex);
      if(!q) return;

      const newId = "q_" + q.id + "_" + Date.now();
      currentQuestionId = newId;
      questionActive    = true;
      reveal            = false;

      stopTimer();
      startTimerForCurrent();

      const updates = {};
      updates["currentQuestionIndex"]    = currentIndex;
      updates["currentQuestionId"]       = currentQuestionId;
      updates["questionActive"]          = true;
      updates["reveal"]                  = false;
      updates["answerOrder/"+currentQuestionId] = 0;
      updates["answers/"+currentQuestionId]     = null;
      rootRef.update(updates);

      if(auto){
        statusLine.textContent = "S√ºre otomatik ba≈üladƒ±.";
      }
      renderQuestion();
    }
    btnStart.addEventListener("click", ()=>startQuestion(false));

    function autoStartIfIdle(){
      if(!configLoaded) return;
      if(questionActive || currentQuestionId || reveal) return;
      startQuestion(true);
    }

    btnReveal.addEventListener("click",()=>{
      if(!currentQuestionId) return;
      rootRef.update({ reveal:true, questionActive:false });
      stopTimer();
      timerLabel.textContent = "S√ºre: 0 sn";
    });

    btnReset.addEventListener("click",()=>{
      if(!confirm("T√ºm skorlar, yanƒ±tlar ve eski nickler silinecek. Emin misin?")) return;
      stopTimer();
      const newToken = Date.now();
      const resetData = {
        sessionToken:newToken,
        currentQuestionIndex:0,
        currentQuestionId:null,
        questionActive:false,
        reveal:false,
        players:null,
        answers:null,
        answerOrder:null
      };
      rootRef.set(resetData);
      sessionToken = newToken;
      sessionLabel.textContent = "#" + String(newToken).slice(-4);

      currentIndex      = 0;
      currentQuestionId = null;
      questionActive    = false;
      reveal            = false;
      timerRemaining    = 0;
      timerLabel.textContent = "S√ºre: ‚Äì";
      podiumEl.style.display = "none";
      podiumEl.innerHTML     = "";
      scoreListEl.innerHTML   = "";
      playerCountEl.textContent = "0";
      statusLine.textContent = "Yeni quiz oturumu ba≈ülatƒ±ldƒ±.";
      renderQuestion();
    });

    function attachDbListeners(){
      rootRef.child("sessionToken").on("value",snap=>{
        const val = snap.val();
        if(val){
          if(sessionToken && sessionToken !== val){
            stopTimer();
            timerRemaining = 0;
            timerLabel.textContent = "S√ºre: ‚Äì";
            currentQuestionId = null;
            questionActive = false;
            reveal = false;
            statusLine.textContent = "Yeni oturum algƒ±landƒ±.";
          }
          sessionToken = val;
          sessionLabel.textContent = "#" + String(val).slice(-4);
        }
      });

      rootRef.child("currentQuestionIndex").on("value",snap=>{
        const idx = snap.val();
        if(idx === null || idx === undefined) return;
        currentIndex = idx;
        renderQuestion();
      });

      rootRef.child("currentQuestionId").on("value",snap=>{
        currentQuestionId = snap.val();
        renderQuestion();
      });

      rootRef.child("questionActive").on("value",snap=>{
        questionActive = !!snap.val();
        if(questionActive){
          startTimerForCurrent();
        }else{
          stopTimer();
          if(currentQuestionId){
            timerLabel.textContent = "S√ºre: 0 sn";
          }else{
            timerLabel.textContent = "S√ºre: ‚Äì";
          }
        }
        renderQuestion();
      });

      rootRef.child("reveal").on("value",snap=>{
        reveal = !!snap.val();
        if(reveal){
          revealModalDismissed = false;
        }
        renderQuestion();
      });

      rootRef.child("players").on("value",snap=>{
        const val = snap.val() || {};
        const arr = Object.entries(val).map(([id,p])=>({
          id,
          nickname: p.nickname || "Anonim",
          score:    p.score    || 0
        }));
        arr.sort((a,b)=> b.score - a.score || (a.nickname > b.nickname ? 1 : -1));
        playerCountEl.textContent = arr.length;
        podiumEl.innerHTML = "";
        scoreListEl.innerHTML = "";

        const positive = arr.filter(p=>p.score>0);
        if(!positive.length){
          podiumEl.style.display = "none";
          const empty = document.createElement("div");
          empty.className = "meta-line small";
          empty.textContent = "Hen√ºz puanlƒ± katƒ±lƒ±mcƒ± yok.";
          scoreListEl.appendChild(empty);
          return;
        }

        let lastScore = null;
        let currentRank = 0;
        const ranked = positive.map(p=>{
          if(lastScore===null || p.score!==lastScore){
            currentRank += 1;
            lastScore = p.score;
          }
          return { ...p, rank: currentRank };
        });

        const scoreCounts = ranked.reduce((acc,p)=>{
          acc[p.score] = (acc[p.score] || 0) + 1;
          return acc;
        },{});

        const topThree = ranked.slice(0,3);
        const order = [1,0,2];
        podiumEl.style.display = "grid";
        order.forEach(idx=>{
          const entry = topThree[idx];
          if(!entry) return;
          const card = document.createElement("div");
          card.className = "podium-card " + (idx===1 ? "first" : idx===0 ? "second" : "third");

          const place = document.createElement("div");
          place.className = "place";
          const tieMark = scoreCounts[entry.score]>1 ? "‚Üî " : "";
          place.textContent = tieMark + entry.rank + ".";

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = entry.nickname;

          const score = document.createElement("div");
          score.className = "score";
          score.textContent = entry.score + " p";

          card.appendChild(place);
          card.appendChild(name);
          card.appendChild(score);
          podiumEl.appendChild(card);
        });

        const rest = ranked.slice(3);
        rest.forEach(p=>{
          const row  = document.createElement("div");
          row.className = "score-row";
          const label = document.createElement("div");
          label.className = "label";
          const medal = document.createElement("span");
          medal.className = "medal";
          const tieMark = scoreCounts[p.score]>1 ? "‚Üî " : "";
          medal.textContent = tieMark + p.rank + ".";
          const name  = document.createElement("span");
          name.className = "name";
          name.textContent  = p.nickname;
          label.appendChild(medal);
          label.appendChild(name);

          const score = document.createElement("span");
          score.className = "score";
          score.textContent = p.score+" p";
          row.appendChild(label);
          row.appendChild(score);
          scoreListEl.appendChild(row);
        });
      });
    }

    async function loadConfig(){
      try{
        const res = await fetch(CONFIG_URL,{cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        CONFIG    = await res.json();
        QUESTIONS = (CONFIG.questions || []).slice();
        TOTAL_Q   = QUESTIONS.length;
        configLoaded = true;

        attachDbListeners();
        renderQuestion();

        rootRef.child("currentQuestionIndex").once("value",s=>{
          if(!s.exists()){
            rootRef.update({ currentQuestionIndex:0 });
          }
        });
        rootRef.child("sessionToken").once("value",snap=>{
          if(!snap.exists()){
            const t = Date.now();
            rootRef.update({ sessionToken:t });
            sessionToken = t;
            sessionLabel.textContent = "#" + String(t).slice(-4);
          }
        });
      }catch(e){
        console.error(e);
        questionTitleEl.textContent = "Config y√ºklenemedi";
        questionStemEl.textContent  = "defi-quiz-config.json dosyasƒ±nƒ± aynƒ± klas√∂re koyduƒüundan emin ol.";
      }
    }

    loadConfig();

    function renderQrModal(){
      if(!playerUrl || !qrLargeBox) return;
      qrLargeBox.innerHTML = "";
      new QRCode(qrLargeBox,{ text: playerUrl, width:420, height:420 });
    }
    function openQrModal(){
      renderQrModal();
      qrModal?.classList.add("show");
    }
    function closeQrModal(){ qrModal?.classList.remove("show"); }
    btnShowQr?.addEventListener("click", openQrModal);
    qrModalClose?.addEventListener("click", closeQrModal);
    qrModal?.addEventListener("click", e=>{ if(e.target===qrModal) closeQrModal(); });

    function showRevealModal(){
      if(!reveal || !currentQuestionId) return;
      revealModalTitle.textContent = revealTitle.textContent;
      revealModalBody.textContent  = revealBody.textContent;
      if(!revealModalDismissed){
        revealModal.classList.add("show");
      }
    }
    function hideRevealModal(fromState){
      if(!fromState){
        revealModalDismissed = true;
      }
      revealModal.classList.remove("show");
    }
    revealModal?.addEventListener("click", e=>{ if(e.target===revealModal) hideRevealModal(false); });

  </script>
</body>
</html>

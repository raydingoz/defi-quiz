<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Defi SimÃ¼latÃ¶rÃ¼ â€“ Host</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase v8 (kolay syntax) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --border: #1f2937;
      --accent: #22c55e;
      --danger: #f97373;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --heading: #f9fafb;
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
      color: var(--text);
      font-size: 15px;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr);
      gap: 10px;
    }

    @media (max-width: 768px) {
      .app {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .top-bar {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .brand {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--heading);
    }

    .pill {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border);
      padding: 3px 9px;
      font-size: 0.8rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15,23,42,0.9);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 10px 10px;
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.9);
      margin-top: 4px;
    }

    /* MONÄ°TÃ–R */

    .monitor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--muted);
    }

    .monitor-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .monitor-led {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34,197,94,0.9);
      animation: led-pulse 1.4s ease-in-out infinite;
    }

    .monitor-screen {
      border-radius: 16px;
      background: #000000;
      border: 1px solid #0f172a;
      padding: 6px 8px;
      position: relative;
      overflow: hidden;
    }

    .grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(15,23,42,0.55) 1px, transparent 1px),
        linear-gradient(90deg, rgba(15,23,42,0.55) 1px, transparent 1px);
      background-size: 0.5rem 0.5rem;
      opacity: 0.55;
      pointer-events: none;
    }

    .ekg-line {
      position: relative;
      height: 60px;
      overflow: hidden;
    }

    .ekg-line::after {
      content: "";
      position: absolute;
      inset: 0;
      background-repeat: repeat-x;
      background-size: 240px 60px;
      background-position: 0 0;
      animation: ekg-scroll 1.6s linear infinite;
      filter: drop-shadow(0 0 6px #22c55e);
    }

    .ekg-off::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='60'%3E%3Cpolyline points='0,30 240,30' fill='none' stroke='%231f2937' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
      filter: none;
    }

    .ekg-nsr::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='60'%3E%3Cpolyline points='0,30 8,30 12,28 14,32 16,30 22,30 26,26 28,20 30,10 32,40 34,30 40,30 48,30 56,30 60,28 62,32 64,30 70,30 74,26 76,20 78,10 80,40 82,30 88,30 96,30 104,30 108,28 110,32 112,30 118,30 122,26 124,20 126,10 128,40 130,30 136,30 144,30 152,30 156,28 158,32 160,30 166,30 170,26 172,20 174,10 176,40 178,30 184,30 192,30 200,30 204,28 206,32 208,30 214,30 218,26 220,20 222,10 224,40 226,30 232,30 240,30' fill='none' stroke='%2322c55e' stroke-width='2' stroke-linejoin='round' stroke-linecap='round'/%3E%3C/svg%3E");
    }

    .ekg-vf::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='60'%3E%3Cpolyline points='0,30 4,10 8,42 12,18 16,46 20,12 24,40 28,14 32,46 36,18 40,38 44,20 48,44 52,16 56,40 60,14 64,46 68,18 72,38 76,22 80,44 84,16 88,40 92,12 96,46 100,18 104,38 108,20 112,44 116,16 120,40 124,14 128,48 132,18 136,38 140,22 144,44 148,16 152,40 156,12 160,46 164,18 168,38 172,20 176,44 180,16 184,40 188,14 192,48 196,18 200,38 204,22 208,44 212,16 216,40 220,12 224,46 228,18 232,38 236,20 240,30' fill='none' stroke='%23f97373' stroke-width='1.8' stroke-linejoin='round' stroke-linecap='round'/%3E%3C/svg%3E");
    }

    .ekg-pvt::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='60'%3E%3Cpolyline points='0,30 6,12 12,48 18,12 24,48 30,12 36,48 42,12 48,48 54,12 60,48 66,12 72,48 78,12 84,48 90,12 96,48 102,12 108,48 114,12 120,48 126,12 132,48 138,12 144,48 150,12 156,48 162,12 168,48 174,12 180,48 186,12 192,48 198,12 204,48 210,12 216,48 222,12 228,48 234,12 240,30' fill='none' stroke='%23fb923c' stroke-width='2.1' stroke-linejoin='round' stroke-linecap='round'/%3E%3C/svg%3E");
    }

    .ekg-torsades::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='60'%3E%3Cpolyline points='0,30 4,12 8,48 12,8 16,52 20,6 24,50 28,10 32,46 36,14 40,42 44,18 48,38 52,22 56,34 60,26 64,30 68,34 72,38 76,42 80,46 84,48 88,46 92,44 96,40 100,36 104,32 108,30 112,28 116,32 120,36 124,40 128,44 132,48 136,50 140,48 144,44 148,40 152,36 156,32 160,30 164,28 168,26 172,24 176,22 180,20 184,18 188,22 192,26 196,30 200,34 204,38 208,42 212,46 216,48 220,46 224,42 228,38 232,34 236,30 240,30' fill='none' stroke='%23fb7185' stroke-width='2' stroke-linejoin='round' stroke-linecap='round'/%3E%3C/svg%3E");
    }

    .ekg-tachy::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='60'%3E%3Cpolyline points='0,30 4,24 6,18 8,30 10,36 12,30 20,30 24,24 26,18 28,30 30,36 32,30 40,30 44,24 46,18 48,30 50,36 52,30 60,30 64,24 66,18 68,30 70,36 72,30 80,30 84,24 86,18 88,30 90,36 92,30 100,30 104,24 106,18 108,30 110,36 112,30 120,30 124,24 126,18 128,30 130,36 132,30 140,30 144,24 146,18 148,30 150,36 152,30 160,30 164,24 166,18 168,30 170,36 172,30 180,30 184,24 186,18 188,30 190,36 192,30 200,30 204,24 206,18 208,30 210,36 212,30 220,30 224,24 226,18 228,30 230,36 232,30 240,30' fill='none' stroke='%23facc15' stroke-width='1.9' stroke-linejoin='round' stroke-linecap='round'/%3E%3C/svg%3E");
    }

    .ekg-tachy-irreg::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='60'%3E%3Cpolyline points='0,30 4,26 6,20 8,32 10,28 12,30 18,30 22,22 24,16 26,34 28,30 30,32 36,30 40,24 42,18 44,32 46,28 48,30 54,30 58,20 60,16 62,36 64,30 66,32 72,30 76,26 78,18 80,34 82,30 84,32 90,30 94,22 96,18 98,34 100,30 102,32 108,30 112,24 114,20 116,32 118,28 120,30 126,30 130,22 132,16 134,34 136,30 138,32 144,30 148,26 150,18 152,34 154,30 156,32 162,30 166,24 168,20 170,32 172,28 174,30 180,30 184,22 186,16 188,34 190,30 192,32 198,30 202,26 204,18 206,34 208,30 210,32 216,30 220,24 222,20 224,32 226,28 228,30 234,30 238,22 240,30' fill='none' stroke='%2381a7ff' stroke-width='1.8' stroke-linejoin='round' stroke-linecap='round'/%3E%3C/svg%3E");
    }

    .ekg-asystole::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='60'%3E%3Cpolyline points='0,30 240,30' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
    }

    .ekg-pea::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='60'%3E%3Cpolyline points='0,32 8,32 12,30 14,26 16,34 18,32 24,32 28,30 30,26 32,34 34,32 40,32 44,30 46,26 48,34 50,32 56,32 60,30 62,26 64,34 66,32 72,32 76,30 78,26 80,34 82,32 88,32 92,30 94,26 96,34 98,32 104,32 108,30 110,26 112,34 114,32 120,32 124,30 126,26 128,34 130,32 136,32 140,30 142,26 144,34 146,32 152,32 156,30 158,26 160,34 162,32 168,32 172,30 174,26 176,34 178,32 184,32 188,30 190,26 192,34 194,32 200,32 204,30 206,26 208,34 210,32 216,32 220,30 222,26 224,34 226,32 232,32 236,30 240,32' fill='none' stroke='%2393c5fd' stroke-width='1.6' stroke-linejoin='round' stroke-linecap='round'/%3E%3C/svg%3E");
    }

    .monitor-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      margin-top: 4px;
      color: var(--muted);
    }

    .tag {
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border);
      font-size: 0.75rem;
    }
    .tag-postshock {
      border-color: #22c55e;
      color: #bbf7d0;
      background: rgba(34,197,94,0.18);
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
    }

    .btn {
      border: none;
      border-radius: var(--radius-pill);
      padding: 10px 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease-out;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      outline: none;
      width: 100%;
    }

    .btn-main {
      background: radial-gradient(circle at top left, #fb923c, #f97316);
      color: #0b1120;
      box-shadow: 0 10px 20px rgba(248,113,22,0.55);
    }

    .btn-cardio {
      background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      color: #020617;
      box-shadow: 0 10px 20px rgba(56,189,248,0.55);
    }

    .btn-sec {
      background: rgba(15,23,42,0.95);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .btn-small {
      font-size: 0.8rem;
      padding: 6px 10px;
    }

    .btn[disabled] {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }

    .scenario-title {
      font-size: 0.92rem;
      color: var(--heading);
      margin-bottom: 3px;
    }

    .scenario-text {
      font-size: 0.88rem;
      color: var(--text);
      margin-bottom: 2px;
      max-height: 90px;
      overflow-y: auto;
    }

    .helper {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      margin-top: 4px;
      color: var(--muted);
    }

    .progress {
      margin-top: 6px;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      transform-origin: left;
      transition: width 0.25s ease-out;
    }

    .shock-flash {
      position: fixed;
      inset: 0;
      background: #ffffff;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease-out;
      z-index: 900;
    }

    /* Skor tablosu */

    .score-list {
      margin-top: 6px;
      font-size: 0.85rem;
      max-height: 280px;
      overflow-y: auto;
    }

    .score-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      border-bottom: 1px dashed rgba(30,41,59,0.6);
    }

    .score-row span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .rank {
      width: 22px;
      text-align: center;
      font-weight: 600;
    }

    .score-name {
      flex: 1;
      margin: 0 4px;
    }

    .score-points {
      width: 40px;
      text-align: right;
    }

    @keyframes ekg-scroll {
      from { background-position: 0 0; }
      to   { background-position: -240px 0; }
    }

    @keyframes led-pulse {
      0%, 100% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.25); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="shock-flash" id="shockFlash"></div>

  <div class="app">
    <div class="top-bar">
      <div class="brand">Defi SimÃ¼latÃ¶rÃ¼ â€“ Host</div>
      <div class="pill">
        <span class="pill-dot"></span>
        KatÄ±lÄ±mcÄ±lar: <span id="playerCount">0</span>
      </div>
    </div>

    <!-- SOL: MonitÃ¶r + Olgu -->
    <div>
      <div class="card">
        <div class="monitor-header">
          <div class="monitor-label">
            <span class="monitor-led"></span>
            <span>Lead II</span>
          </div>
          <div>
            HR: <span id="rateLabel">â€“</span> â€¢
            SÃ¼re: <span id="timerLabel">â€”</span> sn
          </div>
        </div>

        <div class="monitor-screen">
          <div class="grid"></div>
          <div id="ekgLine" class="ekg-line ekg-off"></div>
        </div>

        <div class="monitor-footer">
          <span id="phaseLabel" class="tag">Olgu hazÄ±rlÄ±k</span>
          <span id="modeHint" class="tag">Ritim gizli â€“ baÅŸlatÄ±nca gÃ¶zÃ¼kecek</span>
        </div>
      </div>

      <div class="card">
        <div class="meta-row">
          <span class="pill">
            Skor: <strong id="scoreValue">0</strong> (Ã¶rn. toplam)
          </span>
          <span class="pill">
            Olgu: <span id="sceneIndex">1</span>/<span id="sceneTotal">1</span>
          </span>
        </div>
        <div class="progress">
          <div id="progressFill" class="progress-fill"></div>
        </div>
      </div>

      <div class="card">
        <div class="scenario-title" id="scenarioTitle">Olgu 1</div>
        <div class="scenario-text" id="scenarioText">YÃ¼kleniyor...</div>

        <div class="controls">
          <button id="startBtn" class="btn btn-sec">
            â–¶ Ritmi gÃ¶ster & soruyu baÅŸlat (katÄ±lÄ±mcÄ±lara gÃ¶nder)
          </button>
          <button id="defibBtn" class="btn btn-main" disabled>
            âš¡ Defibrilasyon (200 J) â€“ demo
          </button>
          <button id="cardioBtn" class="btn btn-cardio" disabled>
            âš¡ Senkron kardiyoversiyon â€“ demo
          </button>
          <button id="noShockBtn" class="btn btn-sec" disabled>
            ğŸ¤š Åok yok / KPR / ilaÃ§ â€“ demo
          </button>
        </div>

        <div class="controls" style="margin-top:8px;">
          <button id="prevSceneBtn" class="btn btn-small btn-sec">
            â¬… Ã–nceki olgu
          </button>
          <button id="nextSceneLocalBtn" class="btn btn-small btn-sec">
            â¡ Sonraki olgu (hazÄ±rlÄ±k)
          </button>
        </div>

        <div class="controls" style="margin-top:4px;">
          <button id="resetSessionBtn" class="btn btn-small btn-sec">
            ğŸ” TÃ¼m oturumu ve skorlarÄ± sÄ±fÄ±rla
          </button>
        </div>

        <div class="helper">
          KatÄ±lÄ±mcÄ±lar <strong>defi-sim-player.html</strong> sayfasÄ±na girip nick yazarak
          baÄŸlanacak. Sen â€œRitmi gÃ¶sterâ€e bastÄ±ÄŸÄ±nda aynÄ± olgu ve seÃ§enekler onlara da gidecek.
        </div>
      </div>
    </div>

    <!-- SAÄ: Skor tablosu -->
    <div>
      <div class="card">
        <div class="scenario-title">Skor Tablosu</div>
        <div class="helper">
          DoÄŸru cevaplarda: 1. kiÅŸi 20, 2. 19, 3. 18, 4. 17, 5. 16, 6. ve sonrasÄ± 15 puan.
          YanlÄ±ÅŸ cevap 0 puan.
        </div>
        <div id="scoreList" class="score-list">
          <!-- Oyuncular buraya gelecek -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // === Firebase yapÄ±landÄ±rmasÄ± ===
    const firebaseConfig = {
      apiKey: "AIzaSyDzzwE5VHZAiP2k8P_iocDaq7uGm1zN1cE",
      authDomain: "defi-quiz.firebaseapp.com",
      databaseURL: "https://defi-quiz-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "defi-quiz",
      storageBucket: "defi-quiz.firebasestorage.app",
      messagingSenderId: "642741899462",
      appId: "1:642741899462:web:bcc787a87d0ec69c9b47c7",
      measurementId: "G-SY348RPCVZ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    // DiÄŸer quiz ile karÄ±ÅŸmasÄ±n diye ayrÄ± root:
    const rootRef = db.ref("defiSim");

    // === Olgu seti (ritim ipucu yok) ===
    const SCENES = [
      {
        id: 1,
        title: "Olgu 1 â€“ Ani kollaps",
        text:
          "65 yaÅŸ erkek, acil serviste triyaj sÄ±rasÄ±nda aniden yere yÄ±ÄŸÄ±lÄ±yor. Bilinci kapalÄ±, solunum normal deÄŸil, palpabl nabÄ±z alÄ±namÄ±yor. Ekip olarak KPR baÅŸlatÄ±yorsunuz ve monitÃ¶re baÄŸlanÄ±yorsunuz.",
        wave: "vf",
        hr: "â€”",
        phase: "ResÃ¼sitasyon",
        correctAction: "defib"
      },
      {
        id: 2,
        title: "Olgu 2 â€“ Åok sonrasÄ± deÄŸerlendirme",
        text:
          "AynÄ± hastaya bir ÅŸok uygulandÄ± ve 2 dk KPR yapÄ±ldÄ±. Åimdi kÄ±sa ritim kontrolÃ¼ndesiniz. Hasta gÃ¶zlerini aÃ§Ä±yor, komut alÄ±yor ve hareket etmeye baÅŸlÄ±yor.",
        wave: "nsr",
        hr: "80",
        phase: "Åok sonrasÄ± kontrol",
        correctAction: "no-shock"
      },
      {
        id: 3,
        title: "Olgu 3 â€“ GenÃ§ eriÅŸkin, hipotansif taÅŸikardi",
        text:
          "35 yaÅŸ kadÄ±n, Ã§arpÄ±ntÄ± ve baÅŸ dÃ¶nmesi ile geliyor. TA 70/40 mmHg, soÄŸuk, soluk, bilinÃ§ bulanÄ±k. NabÄ±z Ã§ok hÄ±zlÄ± ve dÃ¼zenli hissediliyor.",
        wave: "tachy",
        hr: "190",
        phase: "NabÄ±zlÄ± taÅŸikardi",
        correctAction: "cardioversion"
      },
      {
        id: 4,
        title: "Olgu 4 â€“ YaÅŸlÄ± hasta, kronik aritmi Ã¶ykÃ¼sÃ¼",
        text:
          "72 yaÅŸ erkek, uzun sÃ¼redir dÃ¼zensiz kalp atÄ±mÄ± Ã¶ykÃ¼sÃ¼ var. Åimdi gÃ¶ÄŸÃ¼s aÄŸrÄ±sÄ±, nefes darlÄ±ÄŸÄ± ve sersemlik ile geliyor. TA 80/50 mmHg, nabÄ±z hÄ±zlÄ± ve dÃ¼zensiz.",
        wave: "tachy-irreg",
        hr: "150",
        phase: "NabÄ±zlÄ± taÅŸikardi",
        correctAction: "cardioversion"
      },
      {
        id: 5,
        title: "Olgu 5 â€“ NabÄ±zsÄ±z, elektriksel aktivite belirsiz",
        text:
          "Acilde yatan bir hastaya Ã§aÄŸrÄ±lÄ±yorsunuz. YataÄŸÄ±nda yanÄ±tsÄ±z, normal solumuyor ve palpabl nabÄ±z alÄ±namÄ±yor. Ekip KPR baÅŸlatÄ±yor, sen monitÃ¶re bakÄ±yorsun.",
        wave: "asystole",
        hr: "0",
        phase: "Arrest deÄŸerlendirme",
        correctAction: "no-shock"
      },
      {
        id: 6,
        title: "Olgu 6 â€“ NabÄ±z yok, monitÃ¶rde elektriksel aktivite",
        text:
          "Ä°leri yaÅŸ bir hasta, serviste ani kÃ¶tÃ¼leÅŸme sonrasÄ± acile alÄ±nÄ±yor. MonitÃ¶rde bir ritim gÃ¶rÃ¼yorsun ancak nabÄ±z palpe edemiyorsun. Hasta yanÄ±tsÄ±z ve apneik.",
        wave: "pea",
        hr: "40",
        phase: "Arrest deÄŸerlendirme",
        correctAction: "no-shock"
      },
      {
        id: 7,
        title: "Olgu 7 â€“ GeniÅŸ kompleks, nabÄ±z alÄ±namÄ±yor",
        text:
          "50 yaÅŸ erkek, gÃ¶ÄŸÃ¼s aÄŸrÄ±sÄ± sonrasÄ± aniden bilincini kaybediyor. Olay yerinde ve acilde nabÄ±z alÄ±namÄ±yor. MonitÃ¶rde hÄ±zlÄ±, geniÅŸ kompleksli elektriksel aktivite gÃ¶rÃ¼yorsun.",
        wave: "pvt",
        hr: "160",
        phase: "ResÃ¼sitasyon",
        correctAction: "defib"
      },
      {
        id: 8,
        title: "Olgu 8 â€“ UzamÄ±ÅŸ QT Ã¶ykÃ¼lÃ¼ hasta",
        text:
          "UzamÄ±ÅŸ QT Ã¶ykÃ¼sÃ¼ olan bir hasta, Ã§arpÄ±ntÄ± sonrasÄ± ani olarak bilincini kaybediyor. NabÄ±z alÄ±namÄ±yor. MonitÃ¶rde ÅŸekli zaman iÃ§inde deÄŸiÅŸen hÄ±zlÄ± bir ritim gÃ¶rÃ¼yorsun.",
        wave: "torsades",
        hr: "220",
        phase: "ResÃ¼sitasyon",
        correctAction: "defib"
      }
    ];

    const ekgLine = document.getElementById("ekgLine");
    const rateLabel = document.getElementById("rateLabel");
    const phaseLabel = document.getElementById("phaseLabel");
    const modeHint = document.getElementById("modeHint");
    const timerLabel = document.getElementById("timerLabel");

    const scenarioTitle = document.getElementById("scenarioTitle");
    const scenarioText = document.getElementById("scenarioText");
    const scoreValue = document.getElementById("scoreValue");
    const sceneIndexSpan = document.getElementById("sceneIndex");
    const sceneTotalSpan = document.getElementById("sceneTotal");
    const progressFill = document.getElementById("progressFill");
    const playerCountSpan = document.getElementById("playerCount");
    const scoreList = document.getElementById("scoreList");

    const startBtn = document.getElementById("startBtn");
    const defibBtn = document.getElementById("defibBtn");
    const cardioBtn = document.getElementById("cardioBtn");
    const noShockBtn = document.getElementById("noShockBtn");
    const prevSceneBtn = document.getElementById("prevSceneBtn");
    const nextSceneLocalBtn = document.getElementById("nextSceneLocalBtn");
    const resetSessionBtn = document.getElementById("resetSessionBtn");
    const shockFlash = document.getElementById("shockFlash");

    let currentSceneIndex = 0;
    let timerInterval = null;
    let deadline = null;
    let hasStarted = false;
    const baseTimerColor = getComputedStyle(timerLabel).color;

    sceneTotalSpan.textContent = SCENES.length;

    // Sadece gÃ¶rsel demo iÃ§in: local timer
    const TIME_LIMIT_MS = 5000;

    function setAnswerButtonsDisabled(disabled) {
      defibBtn.disabled = disabled;
      cardioBtn.disabled = disabled;
      noShockBtn.disabled = disabled;
    }

    function updateMonitorPre(scene) {
      ekgLine.className = "ekg-line ekg-off";
      rateLabel.textContent = scene.hr || "â€“";
      phaseLabel.textContent = "Olgu hazÄ±rlÄ±k";
      modeHint.textContent = "Ritim gizli â€“ baÅŸlatÄ±nca gÃ¶zÃ¼kecek";
      modeHint.className = "tag";
    }

    function updateMonitorActive(scene) {
      ekgLine.className = "ekg-line ekg-" + (scene.wave || "nsr");
      rateLabel.textContent = scene.hr || "â€“";
      phaseLabel.textContent = scene.phase || "";
      modeHint.textContent = "Ritim ekranÄ± â€“ katÄ±lÄ±mcÄ±lar cevaplÄ±yor";
      modeHint.className = "tag";
    }

    function resetTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      timerLabel.style.color = baseTimerColor;
    }

    function startTimer() {
      resetTimer();
      deadline = Date.now() + TIME_LIMIT_MS;

      function tick() {
        const now = Date.now();
        const remaining = deadline - now;
        if (remaining <= 0) {
          resetTimer();
          timerLabel.textContent = "0.0";
          timerLabel.style.color = baseTimerColor;
        } else {
          const sec = remaining / 1000;
          timerLabel.textContent = sec.toFixed(1);
          timerLabel.style.color = sec <= 2 ? "#f97373" : baseTimerColor;
        }
      }

      timerLabel.textContent = (TIME_LIMIT_MS / 1000).toFixed(1);
      timerInterval = setInterval(tick, 100);
    }

    function renderScene() {
      const s = SCENES[currentSceneIndex];
      sceneIndexSpan.textContent = currentSceneIndex + 1;
      scenarioTitle.textContent = s.title;
      scenarioText.textContent = s.text;
      const progress = (currentSceneIndex / SCENES.length) * 100;
      progressFill.style.width = progress + "%";
      hasStarted = false;
      startBtn.disabled = false;
      setAnswerButtonsDisabled(true);
      resetTimer();
      timerLabel.textContent = "â€”";
      updateMonitorPre(s);
    }

    function triggerShockFlash(actionType) {
      shockFlash.style.background = actionType === "cardioversion" ? "#e0f2fe" : "#ffffff";
      shockFlash.style.opacity = "1";
      setTimeout(() => { shockFlash.style.opacity = "0"; }, 120);
    }

    // Sunucuya yeni soru duyur
    function broadcastQuestion() {
      const scene = SCENES[currentSceneIndex];
      const counterRef = rootRef.child("questionCounter");

      counterRef.transaction(cur => (cur || 0) + 1, (err, committed, snap) => {
        if (!committed || !snap) return;
        const qId = snap.val();
        const updates = {};
        updates["currentSceneIndex"] = currentSceneIndex;
        updates["currentQuestionId"] = qId;
        updates["status"] = "running";
        updates["currentQuestionMeta"] = {
          title: scene.title,
          phase: scene.phase || "",
          ts: Date.now()
        };
        updates["answerOrder/" + qId] = 0;
        rootRef.update(updates);
      });
    }

    // Skor tablosu dinleyicisi
    rootRef.child("players").on("value", snap => {
      const players = [];
      snap.forEach(child => {
        const val = child.val() || {};
        players.push({
          id: child.key,
          name: val.nickname || "Anonim",
          score: val.score || 0
        });
      });
      players.sort((a,b) => b.score - a.score || a.name.localeCompare(b.name));

      playerCountSpan.textContent = players.length;
      scoreList.innerHTML = "";
      let totalScore = 0;

      players.forEach((p, idx) => {
        totalScore += p.score;
        const row = document.createElement("div");
        row.className = "score-row";
        const rank = document.createElement("span");
        rank.className = "rank";
        rank.textContent = idx + 1;
        const name = document.createElement("span");
        name.className = "score-name";
        name.textContent = p.name;
        const pts = document.createElement("span");
        pts.className = "score-points";
        pts.textContent = p.score;
        row.appendChild(rank);
        row.appendChild(name);
        row.appendChild(pts);
        scoreList.appendChild(row);
      });

      scoreValue.textContent = totalScore;
    });

    // Host kontrol butonlarÄ±
    startBtn.addEventListener("click", () => {
      if (hasStarted) return;
      hasStarted = true;
      startBtn.disabled = true;
      setAnswerButtonsDisabled(false);
      const s = SCENES[currentSceneIndex];
      updateMonitorActive(s);
      startTimer();
      broadcastQuestion();
    });

    // Demo amaÃ§lÄ±: sadece monitÃ¶rde efekt
    defibBtn.addEventListener("click", () => {
      triggerShockFlash("defib");
    });
    cardioBtn.addEventListener("click", () => {
      triggerShockFlash("cardioversion");
    });

    prevSceneBtn.addEventListener("click", () => {
      if (currentSceneIndex > 0) {
        currentSceneIndex--;
        renderScene();
      }
    });

    nextSceneLocalBtn.addEventListener("click", () => {
      if (currentSceneIndex < SCENES.length - 1) {
        currentSceneIndex++;
        renderScene();
      }
    });

    resetSessionBtn.addEventListener("click", () => {
      if (!confirm("TÃ¼m skorlarÄ± ve oturumu sÄ±fÄ±rlamak istiyor musun?")) return;
      rootRef.set({ questionCounter: 0 });
      currentSceneIndex = 0;
      renderScene();
    });

    // BaÅŸlangÄ±Ã§
    renderScene();
  </script>
</body>
</html>
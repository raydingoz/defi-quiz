<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Defi ALS Sim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23fff'/%3E%3Cpath d='M20 18h24a2 2 0 0 1 2 2v24a2 2 0 0 1-2 2H20a2 2 0 0 1-2-2V20a2 2 0 0 1 2-2zm11 7h2a2 2 0 0 1 2 2v2h3a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-3v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2h-3a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h3v-2a2 2 0 0 1 2-2z' fill='%23055'/%3E%3C/svg%3E" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e2e8f0;
      --accent:#16a34a;
      --danger:#ef4444;
      --text:#0f172a;
      --muted:#334155;
      --heading:#0f172a;
      --radius-lg:20px;
      --radius-pill:999px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:18px;
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
      font-size:16px;
      line-height:1.6;
    }
    .app{max-width:1400px;margin:0 auto;}

    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    .brand{
      font-size:1.35rem;
      font-weight:800;
      letter-spacing:.04em;
      color:var(--heading);
    }
    .top-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      padding:10px 16px;
      font-size:1rem;
      color:var(--muted);
      background:#eef2ff;
    }
    .dot-live{
      width:9px;height:9px;border-radius:999px;
      background:var(--danger);
      box-shadow:0 0 12px rgba(239,68,68,0.9);
    }
    .small{font-size:0.82rem;}

    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.7fr) minmax(0,1fr);
      gap:16px;
    }
    @media(max-width:900px){
      .layout{grid-template-columns:minmax(0,1fr);}
    }

    .card{
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:0 16px 34px rgba(15,23,42,0.12);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .card::before{display:none;}
    .card-inner{position:relative;z-index:1;}

    .section-title{
      font-size:1.05rem;
      color:var(--muted);
      margin-bottom:8px;
      text-transform:uppercase;
      letter-spacing:.1em;
    }
    .case-title{
      font-size:1.5rem;
      font-weight:700;
      color:var(--heading);
      margin-bottom:8px;
    }
    .case-body{font-size:1.12rem;color:var(--text);white-space:pre-wrap;margin-bottom:10px;}
    .tag-row{display:none;}

    .progress-wrap{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .progress-label{
      font-size:1rem;
      color:var(--muted);
    }
    .progress-track{
      flex:1;
      height:8px;
      border-radius:999px;
      background:linear-gradient(90deg,#e5e7eb,#cbd5e1);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.7);
      overflow:hidden;
    }
    .progress-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#f97373,#fbbf24);
      transition:width .35s ease-out;
      box-shadow:0 0 14px rgba(251,191,36,0.5);
    }

    .monitor{
      margin-top:8px;
      border-radius:22px;
      border:1px solid #111827;
      background:#020617;
      padding:12px;
      box-shadow:0 10px 28px rgba(0,0,0,0.8);
      position:relative;
      overflow:hidden;
    }
    .monitor-grid{
      position:absolute;
      inset:0;
      opacity:0.25;
      background-image:
        linear-gradient(to right,#111827 1px,transparent 1px),
        linear-gradient(to bottom,#111827 1px,transparent 1px);
      background-size:16px 10px;
      pointer-events:none;
    }
    .monitor-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      font-size:0.95rem;
      color:var(--muted);
    }
    .ekg-line{
      position:relative;
      height:110px;
      overflow:hidden;
    }
    .ekg-strip{
      position:absolute;
      top:50%;
      left:0;
      transform:translate3d(0,-50%,0);
      width:1200px;
      height:60px;
      display:flex;
    }
    .ekg-strip svg{
      width:240px;
      height:85px;
    }
    .ekg-strip path{stroke:#22c55e;}
    .ekg-strip.sinus path{stroke:#22c55e;}
    .ekg-strip.vf path{stroke:#f97373;}
    .ekg-strip.vt path{stroke:#facc15;}
    .ekg-strip.asystole path{stroke:#22c55e;opacity:0.6;}
    .ekg-strip.pea path{stroke:#38bdf8;}
    .ekg-strip.torsades path{stroke:#f97316;}

    .ekg-strip.anim{
      animation:ekg-move 1.2s linear infinite;
    }
    @keyframes ekg-move{
      from{transform:translate3d(0,-50%,0);}
      to{transform:translate3d(-240px,-50%,0);}
    }

    .monitor-footer{
      margin-top:4px;
      font-size:0.95rem;
      display:flex;
      justify-content:space-between;
      color:var(--muted);
    }

    .timer-pill{border-radius:var(--radius-pill);border:1px solid #cbd5e1;font-size:1.05rem;padding:8px 14px;color:#0f172a;font-weight:800;background:#f1f5f9;font-variant-numeric:tabular-nums;letter-spacing:0.02em;box-shadow:none;}
    .timer-pill.live{background:#e0f2fe;border-color:#bae6fd;color:#0c4a6e;}

    .btn-row{margin-top:12px;display:flex;gap:10px;flex-wrap:nowrap;align-items:center;}
    .btn-row .btn{flex:1;justify-content:center;min-width:0;}
    @media(max-width:1100px){.btn-row{flex-wrap:wrap;}}
    .btn{
      border-radius:var(--radius-pill);
      border:1px solid #cbd5e1;
      background:#ffffff;
      color:var(--heading);
      font-size:1.02rem;
      font-weight:800;
      padding:11px 18px;
      display:inline-flex;
      gap:6px;
      align-items:center;
      cursor:pointer;
      transition:all .15s ease-out;
      box-shadow:0 12px 24px rgba(15,23,42,0.12);
    }
    .btn-main{
      background:#ef4444;
      border:none;
      color:#fff7ed;
      box-shadow:0 14px 28px rgba(239,68,68,0.65);
    }
    .btn[disabled]{opacity:0.45;cursor:default;box-shadow:none;}
    .btn-danger{color:#b91c1c;border-color:#fecaca;background:#fff1f2;}

    .meta-line{
      font-size:1rem;
      color:var(--muted);
      margin-top:6px;
    }

    .reveal-box{margin-top:14px;padding:14px;border-radius:18px;border:1px dashed #cbd5e1;background:#f8fafc;box-shadow:0 12px 28px rgba(15,23,42,0.08);}
    .reveal-title{font-weight:800;color:var(--heading);margin-bottom:8px;display:flex;align-items:center;gap:8px;}
    .reveal-body{font-size:1.08rem;color:var(--text);white-space:pre-wrap;line-height:1.7;}

    .score-list{margin-top:10px;font-size:1.15rem;max-height:360px;overflow-y:auto;}
    .score-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px dashed #cbd5e1;gap:10px;font-weight:800;}
    .score-row .label{display:flex;align-items:center;gap:12px;max-width:240px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
    .score-row .medal{font-size:1.1rem;}
    .score-row .name{flex:1;overflow:hidden;text-overflow:ellipsis;}
    .score-row .score{font-weight:800;color:#0f172a;font-size:1.1rem;}
    .score-row.rank-1 .medal,.score-row.rank-1 .name{color:#d4af37;}
    .score-row.rank-2 .medal,.score-row.rank-2 .name{color:#c0c0c0;}
    .score-row.rank-3 .medal,.score-row.rank-3 .name{color:#cd7f32;}

    .qr-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;}
    .qr-actions button{border:1px solid #cbd5e1;background:#0f172a;color:#e2e8f0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 12px 24px rgba(15,23,42,0.18);letter-spacing:0.01em;}
    .qr-actions button:hover{background:#111827;}
    .qr-modal,.reveal-modal{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:9999;}
    .qr-modal.show,.reveal-modal.show{display:flex;}
    .qr-modal .modal-card{background:#ffffff;border-radius:20px;padding:18px;box-shadow:0 18px 44px rgba(0,0,0,0.28);text-align:center;max-width:520px;}
    #qrcodeSimLarge{width:420px;height:420px;margin:0 auto;}
    .reveal-modal .modal-card{background:#ffffff;border-radius:20px;padding:20px;box-shadow:0 18px 44px rgba(0,0,0,0.28);max-width:900px;width:90%;}
    .reveal-modal .modal-heading{font-size:1.25rem;font-weight:800;margin-bottom:12px;color:var(--heading);}
    .reveal-modal .modal-body{color:var(--text);white-space:pre-line;text-align:left;font-size:1.12rem;line-height:1.8;}
    .modal-close{margin-top:12px;border:none;background:#0f172a;color:#e2e8f0;padding:12px 16px;border-radius:14px;font-weight:800;cursor:pointer;}
  </style>
</head>
<body>
  <div class="app">
    <header class="top-bar">
      <div class="brand">Defi ALS Sim</div>
      <div class="top-pill">
        <span class="dot-live"></span>
        <span>ALS ritim kararƒ±</span>
        <span id="sessionLabel" class="small"></span>
      </div>
    </header>

    <main class="layout">
      <!-- SOL: Olgu + monit√∂r -->
      <section class="card">
        <div class="card-inner">
          <div class="section-title">Olgu & Monit√∂r</div>

          <div class="progress-wrap">
            <div class="progress-label" id="progressLabel">Olgu ‚Äì / ‚Äì</div>
            <div class="progress-track">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>

          <div class="case-title" id="caseTitle">Olgu ba≈ülƒ±ƒüƒ±</div>
          <div class="case-body" id="caseNarrative">
            Config y√ºkleniyor (defi-als-config.json)‚Ä¶
          </div>
          <div class="tag-row" id="caseTags"></div>

          <div class="monitor">
            <div class="monitor-grid"></div>
            <div class="monitor-header">
              <span>Lead II</span>
              <span class="timer-pill" id="timerLabel">S√ºre: ‚Äì</span>
            </div>
            <div class="ekg-line">
              <div class="ekg-strip blank" id="ekgStrip">
                <svg viewBox="0 0 240 60" preserveAspectRatio="none">
                  <polyline id="ekgPath1" fill="none" stroke="#22c55e" stroke-width="2"
                    stroke-linejoin="round" stroke-linecap="round"
                    points="" />
                </svg>
                <svg viewBox="0 0 240 60" preserveAspectRatio="none">
                  <polyline id="ekgPath2" fill="none" stroke="#22c55e" stroke-width="2"
                    stroke-linejoin="round" stroke-linecap="round"
                    points="" />
                </svg>
                <svg viewBox="0 0 240 60" preserveAspectRatio="none">
                  <polyline id="ekgPath3" fill="none" stroke="#22c55e" stroke-width="2"
                    stroke-linejoin="round" stroke-linecap="round"
                    points="" />
                </svg>
                <svg viewBox="0 0 240 60" preserveAspectRatio="none">
                  <polyline fill="none" stroke="#22c55e" stroke-width="2"
                    stroke-linejoin="round" stroke-linecap="round"
                    points="" />
                </svg>
                <svg viewBox="0 0 240 60" preserveAspectRatio="none">
                  <polyline fill="none" stroke="#22c55e" stroke-width="2"
                    stroke-linejoin="round" stroke-linecap="round"
                    points="" />
                </svg>
              </div>
            </div>
            <div class="monitor-footer">
              <span>HR: ?</span>
              <span>SpO‚ÇÇ: ?</span>
            </div>
          </div>

          <div class="btn-row">
            <button id="btnPrev" class="btn">‚üµ √ñnceki olgu</button>
            <button id="btnNext" class="btn">Sonraki olgu ‚ü∂</button>
            <button id="btnStartCase" class="btn btn-main">‚ñ∂ Ritim + s√ºreyi ba≈ülat</button>
            <button id="btnReveal" class="btn">‚úÖ Doƒüru yakla≈üƒ±mƒ± g√∂ster</button>
          </div>
          <div class="meta-line" id="statusLine">
            Olguyu tanƒ±t; hazƒ±r olduƒüunda ‚ÄúRitim + s√ºreyi ba≈ülat‚Äù ile hem sende hem katƒ±lƒ±mcƒ±larda ritmi a√ß.
          </div>

          <div class="reveal-box" id="revealBox" style="display:none;">
            <div class="reveal-title" id="revealTitle">Doƒüru yakla≈üƒ±m</div>
            <div class="reveal-body" id="revealBody">A√ßƒ±klama y√ºklenecek.</div>
          </div>
        </div>
      </section>

      <!-- SAƒû: Skor & QR butonu -->
      <aside class="card">
        <div class="card-inner">
          <div class="section-title">Skor & Katƒ±lƒ±mcƒ±lar</div>
          <div class="meta-line" style="margin-bottom:6px;">
            Katƒ±lƒ±mcƒ±: <span id="playerCount">0</span>
          </div>
          <div id="scoreList" class="score-list"></div>

          <div class="qr-actions">
            <button id="btnShowQr">üì± Katƒ±lƒ±m QR'ƒ±nƒ± G√∂ster</button>
            <button id="btnResetSession" class="btn btn-danger small" style="box-shadow:none;">
              üîÅ Sƒ±fƒ±rla
            </button>
          </div>
          <div class="meta-line small" style="margin-top:6px;">
            QR ba≈üta otomatik a√ßƒ±lƒ±r; ihtiya√ß olursa butondan tekrar g√∂sterin.
          </div>
        </div>
      </aside>
    </main>
  </div>

  <div class="qr-modal" id="qrModal">
    <div class="modal-card">
      <div id="qrcodeSimLarge"></div>
      <button class="modal-close" id="qrModalClose">Kapat</button>
    </div>
  </div>

  <div class="reveal-modal" id="revealModal">
    <div class="modal-card">
      <div class="modal-heading" id="revealModalTitle">Doƒüru yakla≈üƒ±m</div>
      <div class="modal-body" id="revealModalBody">A√ßƒ±klama y√ºklenecek.</div>
      <button class="modal-close" id="revealModalClose">Kapat</button>
    </div>
  </div>

  <script>
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDzzwE5VHZAiP2k8P_iocDaq7uGm1zN1cE",
      authDomain: "defi-quiz.firebaseapp.com",
      databaseURL: "https://defi-quiz-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "defi-quiz",
      storageBucket: "defi-quiz.firebasestorage.app",
      messagingSenderId: "642741899462",
      appId: "1:642741899462:web:bcc787a87d0ec69c9b47c7",
      measurementId: "G-SY348RPCVZ"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db     = firebase.database();
    const rootRef= db.ref("defiSim");

    const CONFIG_URL = "defi-als-config.json";

    let CONFIG       = null;
    let CASES        = [];
    let TOTAL_CASES  = 0;
    let configLoaded = false;

    let sessionToken        = null;
    let currentIndex        = 0;
    let currentCaseId       = null;
    let currentRhythmActive = false;
    let currentReveal       = false;
    let revealModalDismissed = false;

    let timerInterval = null;
    let timerRemaining = 0;
    let playerUrl = "";
    let qrModalShown = false;

    // DOM
    const caseTitleEl   = document.getElementById("caseTitle");
    const caseNarrEl    = document.getElementById("caseNarrative");
    const caseTagsEl    = document.getElementById("caseTags");
    const timerLabel    = document.getElementById("timerLabel");
    const statusLine    = document.getElementById("statusLine");
    const revealBox     = document.getElementById("revealBox");
    const revealTitle   = document.getElementById("revealTitle");
    const revealBody    = document.getElementById("revealBody");
    const revealModal   = document.getElementById("revealModal");
    const revealModalTitle = document.getElementById("revealModalTitle");
    const revealModalBody  = document.getElementById("revealModalBody");
    const revealModalClose = document.getElementById("revealModalClose");

    const btnPrev       = document.getElementById("btnPrev");
    const btnNext       = document.getElementById("btnNext");
    const btnStart      = document.getElementById("btnStartCase");
    const btnReveal     = document.getElementById("btnReveal");
    const btnReset      = document.getElementById("btnResetSession");

    const ekgStripEl    = document.getElementById("ekgStrip");
    const ekgPaths      = Array.from(document.querySelectorAll("#ekgStrip polyline"));

    const sessionLabel  = document.getElementById("sessionLabel");
    const playerCountEl = document.getElementById("playerCount");
    const scoreListEl   = document.getElementById("scoreList");
    const btnShowQr     = document.getElementById("btnShowQr");
    const qrModal       = document.getElementById("qrModal");
    const qrModalClose  = document.getElementById("qrModalClose");
    const qrLargeBox    = document.getElementById("qrcodeSimLarge");

    const progressLabel = document.getElementById("progressLabel");
    const progressFill  = document.getElementById("progressFill");

    // EKG ≈üekilleri
   const EKG_SHAPES = {
  "sinus": "0,30 3,30 6,27 9,30 14,29 14,32 17,1 18,33 21,29 25,29 28,24 32,29 36,31 41,31 48,31 56,30 64,30 74,30 82,30 86,27 89,30 93,30 94,32 97,0 98,33 101,30 105,29 108,24 110,27 113,31 119,31 128,31 136,29 144,30 154,30 158,30 165,30 167,28 170,31 174,31 175,32 177,2 179,35 183,31 185,30 188,25 190,26 192,31 198,31 207,31 216,31 225,30 235,30 240,30",
  "vf": "0,30 3,25 5,32 8,33 9,30 10,26 11,24 14,25 15,29 17,32 19,33 22,29 23,24 25,24 29,28 30,32 32,32 36,26 37,21 38,19 42,36 46,38 48,30 48,23 49,18 52,16 53,24 54,30 58,37 59,36 60,27 62,22 66,21 70,32 72,31 77,26 81,23 84,29 84,31 87,28 91,22 92,21 96,27 97,31 99,31 101,29 101,25 105,24 109,28 112,30 114,27 117,22 120,26 122,33 125,34 131,28 134,24 136,29 137,32 142,30 144,25 145,24 150,28 152,32 154,33 156,29 156,26 159,25 165,30 168,31 169,25 170,23 176,30 179,32 183,26 184,22 186,20 189,23 194,26 196,31 197,30 201,18 204,19 209,26 210,29 211,30 213,25 218,30 220,32 224,30 226,25 228,27 231,35 231,35 233,32 234,30 238,36 240,30",
  "vf_fine": "0,30 3,32 7,28 13,31 18,33 24,32 28,29 32,27 37,28 41,30 45,30 50,29 54,28 59,28 67,30 71,32 75,31 79,30 84,28 88,27 91,28 95,30 99,30 103,29 105,27 105,27 108,27 112,32 116,32 117,29 120,27 123,30 125,30 128,28 133,28 137,30 142,28 147,25 148,28 154,29 158,29 161,30 164,28 166,25 170,28 174,30 175,30 177,30 187,29 193,27 196,27 205,28 209,30 216,30 219,30 229,29 235,28 240,30",
  "vt": "0,30 3,12 5,36 7,39 10,42 14,32 16,13 19,34 23,42 27,32 30,12 32,36 36,42 40,34 43,12 45,35 50,42 54,33 57,12 59,35 64,42 67,34 70,12 73,36 77,42 81,33 83,13 86,37 90,43 94,33 97,13 101,38 104,44 108,34 110,13 113,36 117,43 121,34 123,13 126,36 130,43 133,35 136,14 139,35 143,43 148,34 150,14 153,35 158,44 161,34 163,13 166,36 169,44 174,35 177,15 179,37 183,43 187,32 189,13 192,37 196,44 200,34 202,12 206,37 209,44 213,32 216,13 219,37 223,43 226,33 229,14 232,37 236,44 240,30",
  "torsades": "0,30 4,34 7,29 10,30 15,35 17,28 19,39 22,25 24,42 28,16 30,42 33,18 35,42 38,17 40,41 42,21 44,40 48,15 50,42 53,14 55,44 58,15 60,45 62,15 65,41 67,18 70,40 73,17 75,41 77,23 79,33 81,27 84,37 87,28 89,36 90,30 93,33 95,30 97,28 97,31 101,27 104,32 106,26 109,34 112,24 114,37 118,20 120,35 122,28 125,35 128,19 130,36 134,20 136,40 140,19 142,36 145,24 147,37 150,25 152,32 156,30 157,27 158,33 160,31 162,25 164,30 166,32 168,28 169,33 172,27 175,33 178,24 180,33 183,27 185,33 188,25 190,29 191,38 193,23 196,38 198,23 201,40 203,24 206,22 207,39 209,25 211,22 213,38 216,26 219,32 222,27 225,34 227,32 228,24 231,36 232,29 235,27 236,30 239,28 240,30",
  "asystole": "0,30 3,31 17,30 30,30 41,27 51,28 61,30 75,31 85,31 96,30 107,28 119,28 128,30 139,32 154,31 171,29 178,28 189,27 201,27 221,29 229,29 240,30",
  "pea": "0,30 42,33 57,33 75,33 82,30 85,4 92,1 94,31 96,37 99,42 102,42 106,34 109,31 113,31 117,33 133,34 152,34 165,34 182,34 199,33 212,33 231,31 240,30",
  "svt": "0,30 0,30 5,41 10,41 11,1 13,55 15,47 19,42 23,30 28,41 32,40 35,2 35,55 38,48 43,45 46,31 50,40 54,42 56,40 58,1 59,56 61,50 65,45 70,32 73,40 76,42 79,42 82,1 83,57 84,50 90,44 93,31 96,42 102,43 105,0 107,57 110,47 113,45 117,33 121,42 127,44 129,1 130,58 132,51 135,49 136,44 140,35 143,38 144,45 148,45 151,46 153,0 154,59 155,53 156,47 161,46 164,37 165,31 168,34 170,40 176,40 178,0 180,54 182,47 186,44 189,31 191,31 194,40 198,41 200,41 201,0 204,55 206,47 211,44 215,31 219,40 220,41 226,42 227,0 229,56 230,50 237,43 238,34 240,30",
  "af": "0,30 2,32 5,1 6,41 13,26 15,36 21,33 23,4 26,42 29,34 33,32 35,42 38,40 40,9 41,42 43,36 47,32 50,43 54,41 57,8 59,42 62,33 69,36 69,42 75,37 77,42 81,35 83,37 85,3 87,44 90,35 95,29 99,40 102,6 104,43 106,34 109,37 111,31 113,37 118,35 121,40 122,3 124,38 128,28 129,30 132,26 133,36 138,32 140,35 142,6 142,41 145,36 149,26 150,35 153,37 153,44 158,38 160,42 162,37 165,39 167,5 168,42 172,39 174,31 176,35 180,39 183,42 185,7 188,42 190,33 193,35 194,30 196,41 200,40 201,37 204,42 206,37 210,36 210,34 213,39 215,8 217,45 220,37 222,31 225,39 228,40 228,45 231,7 233,46 236,42 237,35 238,37 240,30",
  "flutter": "0,30 1,31 5,35 7,30 12,29 20,34 23,33 24,28 27,28 34,34 37,33 38,28 40,28 46,35 48,30 49,6 50,29 54,33 59,27 62,27 70,32 72,32 73,26 76,26 84,32 87,32 87,26 90,26 94,32 98,30 99,7 101,30 104,35 108,35 112,31 116,32 121,35 124,34 125,29 128,30 136,36 139,35 140,30 144,31 146,35 148,30 150,7 151,30 154,34 156,35 160,28 163,29 170,34 173,34 174,28 177,28 184,34 188,34 188,29 190,29 195,33 198,29 200,4 202,30 204,33 206,33 210,27 213,27 219,32 223,32 225,26 227,26 233,32 238,30 239,6 240,30",
  "af_wpw": "0,30 2,52 6,20 8,14 13,11 14,17 15,23 16,31 19,40 22,59 27,29 28,16 33,7 35,15 38,29 43,59 46,30 54,9 58,29 62,59 65,30 72,15 77,31 79,59 83,31 90,11 94,21 97,29 105,30 107,34 111,33 112,59 118,25 122,12 125,8 130,23 134,28 139,28 143,33 147,36 149,58 151,43 154,28 160,8 164,16 167,26 171,31 173,36 177,53 178,36 181,30 186,13 190,27 196,34 198,38 199,58 203,59 205,30 210,12 213,8 215,13 219,24 221,32 226,33 231,32 238,34 240,30",
  "paced": "0,30 1,22 8,22 11,29 24,29 25,38 26,28 28,45 30,40 32,22 36,22 40,29 47,28 47,38 49,28 50,29 51,46 53,41 54,23 62,22 66,29 79,29 79,39 80,28 82,28 83,47 86,41 87,24 89,22 93,21 97,29 111,29 112,40 113,28 115,30 115,46 118,39 119,23 127,21 130,29 141,29 144,29 145,40 146,29 148,29 148,47 150,39 151,23 154,23 159,23 163,29 174,29 175,39 176,29 178,30 179,46 181,41 182,23 186,21 190,22 194,29 200,29 207,29 208,39 209,28 211,31 212,46 213,38 215,24 217,22 222,22 226,29 230,28 233,29 234,37 235,29 237,29 237,46 239,41 240,30",
  "artifact": "0,30 1,36 1,26 3,28 4,34 5,18 7,39 8,19 10,32 11,17 12,40 15,33 15,42 18,33 19,15 19,42 22,32 24,31 25,15 27,38 28,28 29,38 31,31 32,7 33,26 34,39 35,33 35,40 37,34 38,36 41,18 42,46 45,33 48,30 49,20 50,38 51,30 53,32 55,10 57,36 60,33 62,34 63,22 64,41 68,33 71,31 71,24 74,33 75,30 77,33 79,18 81,38 82,32 84,37 85,32 87,39 88,32 89,37 94,28 96,36 97,27 101,34 103,13 104,34 106,32 107,38 109,33 113,37 116,31 118,33 119,27 122,32 125,33 125,10 129,34 132,31 133,37 135,31 137,39 138,32 140,27 141,32 142,27 144,34 145,29 146,32 148,29 149,7 152,36 155,33 156,21 158,42 159,36 162,31 164,18 164,40 167,29 170,20 172,42 172,19 175,34 176,24 178,39 179,34 183,34 184,24 185,38 187,31 190,31 191,20 193,37 195,32 196,14 199,36 202,32 203,29 204,37 208,27 209,33 210,32 213,24 215,36 216,30 217,33 220,17 223,33 223,41 225,31 226,36 228,34 230,37 232,32 234,26 235,32 237,31 238,28 240,30"
};

    function safeCase(idx){
      if(!CASES.length) return null;
      if(idx<0) idx=0;
      if(idx>=CASES.length) idx=CASES.length-1;
      return CASES[idx];
    }

    function stopTimer(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function startTimerForCurrent(){
      stopTimer();
      const c = safeCase(currentIndex);
      if(!c){
        timerLabel.textContent="S√ºre: ‚Äì";
        return;
      }
      timerRemaining = c.timeLimitSec || 8;
      timerLabel.textContent = "S√ºre: "+timerRemaining+" sn";
      timerInterval = setInterval(()=>{
        timerRemaining -= 1;
        if(timerRemaining <= 0){
          stopTimer();
          timerLabel.textContent = "S√ºre: 0 sn";
          rootRef.update({ currentRhythmActive:false });
        }else{
          timerLabel.textContent="S√ºre: "+timerRemaining+" sn";
        }
      },1000);
    }

    function applyRhythm(key, animate){
      const k = key || "blank";
      const shape = EKG_SHAPES[k] || "";
      ekgPaths.forEach(p=>p.setAttribute("points", shape));
      ekgStripEl.className = "ekg-strip " + k + (animate ? " anim" : "");
    }

    function actionLabel(key){
      if(key === "shock") return "‚ö° Defibrilasyon";
      if(key === "noShock") return "‚è∏ CPR devam / medikal";
      if(key === "cardioversion") return "‚ù§Ô∏è Kardiyoversiyon";
      return "Doƒüru yakla≈üƒ±m";
    }

    function showRevealModal(){
      const c = safeCase(currentIndex);
      if(!c || !currentReveal || !currentCaseId) return;
      const pieces = [actionLabel(c.correctAction)];
      if(c.type) pieces.push(c.type);
      const heading = pieces.filter(Boolean).join(" ‚Ä¢ ");
      const body = c.explanation || "A√ßƒ±klama hen√ºz eklenmemi≈ü.";

      revealTitle.textContent = heading;
      revealBody.textContent  = body;
      revealModalTitle.textContent = heading;
      revealModalBody.textContent  = body;
      revealBox.style.display = "none";
      revealModal.classList.add("show");
      revealModalDismissed = false;
    }

    function hideRevealModal(){
      revealModal.classList.remove("show");
      revealModalDismissed = true;
    }

    revealModalClose?.addEventListener("click", hideRevealModal);

    function renderRevealBox(){
      if(!revealBox || !revealModal) return;
      const c = safeCase(currentIndex);
      if(!c || !currentReveal || !currentCaseId){
        revealBox.style.display = "none";
        revealModal.classList.remove("show");
        revealModalDismissed = false;
        return;
      }
      if(!revealModalDismissed) showRevealModal();
    }

    function updateProgress(){
      if(!TOTAL_CASES || currentIndex==null){
        progressLabel.textContent = "Olgu ‚Äì / ‚Äì";
        progressFill.style.width  = "0%";
        return;
      }
      const idx = currentIndex + 1;
      progressLabel.textContent = "Olgu " + idx + " / " + TOTAL_CASES;
      const pct = Math.max(0, Math.min(1, idx / TOTAL_CASES));
      progressFill.style.width = (pct * 100).toFixed(1) + "%";
    }

    function renderCase(){
      if(!configLoaded) return;
      const c = safeCase(currentIndex);
      if(!c) return;

      caseTitleEl.textContent = c.title || ("Olgu " + (currentIndex+1));
      caseNarrEl.textContent  = c.narrative || "";
      caseTagsEl.innerHTML = "";

      const rhythmKey = (currentCaseId && c.rhythmKey) ? c.rhythmKey : "blank";
      applyRhythm(rhythmKey, !!currentRhythmActive);

      if(!currentCaseId){
        statusLine.textContent = "Olguyu tanƒ±t, sonra 'Ritim + s√ºreyi ba≈ülat' ile ritmi a√ß.";
      }else if(!currentReveal && !currentRhythmActive){
        statusLine.textContent = "S√ºre doldu; ritim ekranda, yanƒ±tlar puansƒ±z olarak toplanƒ±yor.";
      }else if(currentRhythmActive){
        statusLine.textContent = "Ritim a√ßƒ±k, katƒ±lƒ±mcƒ±lar karar veriyor.";
      }else if(currentReveal){
        statusLine.textContent = "Doƒüru yakla≈üƒ±m g√∂sterildi, olguyu tartƒ±≈üabilirsin.";
      }

      timerLabel.classList.toggle("live", !!currentRhythmActive);
      renderRevealBox();
      updateProgress();
    }

    function renderQr(targetEl, size){
      if(!targetEl || !playerUrl) return;
      targetEl.innerHTML = "";
      new QRCode(targetEl,{ text: playerUrl, width:size, height:size });
    }

    function openQrModal(auto){
      if(!playerUrl) return;
      renderQr(qrLargeBox, 420);
      qrModal.classList.add("show");
      if(auto) qrModalShown = true;
    }

    function closeQrModal(){
      qrModal.classList.remove("show");
    }

    function initQR(){
      try{
        const href = window.location.href;
        playerUrl = href.replace(/defi-sim-host(\.html)?/,"defi-sim-player.html");
        renderQr(qrLargeBox, 420);
        if(!qrModalShown){
          qrModalShown = true;
          setTimeout(()=>openQrModal(true), 200);
        }
      }catch(e){console.error(e);}
    }
    initQR();
    btnShowQr.addEventListener("click", ()=>openQrModal(false));
    qrModalClose.addEventListener("click", closeQrModal);
    qrModal.addEventListener("click", e=>{ if(e.target===qrModal) closeQrModal(); });

    // Butonlar
    btnPrev.addEventListener("click",()=>{
      if(!configLoaded) return;
      currentIndex = Math.max(0, currentIndex-1);
      currentCaseId = null;
      currentRhythmActive = false;
      currentReveal = false;
      stopTimer();
      timerRemaining = 0;
      timerLabel.textContent = "S√ºre: ‚Äì";
      rootRef.update({
        currentCaseIndex: currentIndex,
        currentCaseId: null,
        currentRhythmActive: false,
        currentReveal: false
      });
      renderCase();
    });

    btnNext.addEventListener("click",()=>{
      if(!configLoaded) return;
      currentIndex = Math.min(TOTAL_CASES-1, currentIndex+1);
      currentCaseId = null;
      currentRhythmActive = false;
      currentReveal = false;
      stopTimer();
      timerRemaining = 0;
      timerLabel.textContent = "S√ºre: ‚Äì";
      rootRef.update({
        currentCaseIndex: currentIndex,
        currentCaseId: null,
        currentRhythmActive: false,
        currentReveal: false
      });
      renderCase();
    });

    function startCase(){
      if(!configLoaded) return;
      const c = safeCase(currentIndex);
      if(!c) return;
      const newId = "c_" + c.id + "_" + Date.now();

      currentCaseId       = newId;
      currentRhythmActive = true;
      currentReveal       = false;
      revealModalDismissed = false;
      revealModal.classList.remove("show");

      stopTimer();
      startTimerForCurrent();

      const updates = {};
      updates["currentCaseIndex"]       = currentIndex;
      updates["currentCaseId"]          = currentCaseId;
      updates["currentRhythmActive"]    = true;
      updates["currentReveal"]          = false;
      updates["answerOrder/"+currentCaseId] = 0;
      updates["answers/"+currentCaseId]     = null;
      rootRef.update(updates);

      statusLine.textContent = "Ritim a√ßƒ±ldƒ±, s√ºre ba≈üladƒ±.";
      renderCase();
    }
    btnStart.addEventListener("click", startCase);

    btnReveal.addEventListener("click",()=>{
      if(!currentCaseId) return;
      if(currentReveal){
        showRevealModal();
        return;
      }
      rootRef.update({ currentReveal:true, currentRhythmActive:false });
      stopTimer();
      timerLabel.textContent = "S√ºre: 0 sn";
    });

    btnReset.addEventListener("click",()=>{
      if(!confirm("T√ºm skorlar, yanƒ±tlar ve eski nickler silinecek. Emin misin?")) return;
      stopTimer();
      const newToken = Date.now();
      const resetData = {
        sessionToken:newToken,
        currentCaseIndex:0,
        currentCaseId:null,
        currentRhythmActive:false,
        currentReveal:false,
        players:null,
        answers:null,
        answerOrder:null
      };
      rootRef.set(resetData);
      sessionToken = newToken;
      sessionLabel.textContent = "#" + String(newToken).slice(-4);

      currentIndex        = 0;
      currentCaseId       = null;
      currentRhythmActive = false;
      currentReveal       = false;
      timerRemaining      = 0;
      timerLabel.textContent = "S√ºre: ‚Äì";
      scoreListEl.innerHTML   = "";
      playerCountEl.textContent = "0";
      statusLine.textContent = "Yeni ALS sim oturumu ba≈ülatƒ±ldƒ±.";
      renderCase();
    });

    function attachDbListeners(){
      rootRef.child("sessionToken").on("value",snap=>{
        const val = snap.val();
        if(val){
          if(sessionToken && sessionToken !== val){
            stopTimer();
            timerRemaining = 0;
            timerLabel.textContent = "S√ºre: ‚Äì";
            currentCaseId = null;
            currentRhythmActive = false;
            currentReveal = false;
            statusLine.textContent = "Yeni oturum algƒ±landƒ±.";
          }
          sessionToken = val;
          sessionLabel.textContent = "#" + String(val).slice(-4);
        }
      });

      rootRef.child("currentCaseIndex").on("value",snap=>{
        const idx = snap.val();
        if(idx === null || idx === undefined) return;
        currentIndex = idx;
        renderCase();
      });

      rootRef.child("currentCaseId").on("value",snap=>{
        currentCaseId = snap.val();
        renderCase();
      });

      rootRef.child("currentRhythmActive").on("value",snap=>{
        currentRhythmActive = !!snap.val();
        if(currentRhythmActive){
          startTimerForCurrent();
        }else{
          stopTimer();
          if(currentCaseId){
            timerLabel.textContent = "S√ºre: 0 sn";
          }else{
            timerLabel.textContent = "S√ºre: ‚Äì";
          }
        }
        renderCase();
      });

      rootRef.child("currentReveal").on("value",snap=>{
        currentReveal = !!snap.val();
        if(currentReveal){
          revealModalDismissed = false;
        }
        renderCase();
      });

      rootRef.child("players").on("value",snap=>{
        const val = snap.val() || {};
        const arr = Object.entries(val).map(([id,p])=>({
          id,
          nickname: p.nickname || "Anonim",
          score:    p.score    || 0
        }));
        arr.sort((a,b)=> b.score - a.score || (a.nickname > b.nickname ? 1 : -1));
        playerCountEl.textContent = arr.length;
        scoreListEl.innerHTML = "";
        if(!arr.length){
          const empty = document.createElement("div");
          empty.className = "meta-line small";
          empty.textContent = "Hen√ºz katƒ±lƒ±mcƒ± yok.";
          scoreListEl.appendChild(empty);
          return;
        }

        let lastScore = null;
        let currentRank = 0;
        const ranked = arr.map(p=>{
          if(lastScore===null || p.score!==lastScore){
            currentRank += 1;
            lastScore = p.score;
          }
          return { ...p, rank: currentRank };
        });

        const scoreCounts = ranked.reduce((acc,p)=>{
          acc[p.score] = (acc[p.score] || 0) + 1;
          return acc;
        },{});

        ranked.forEach(p=>{
          const row  = document.createElement("div");
          row.className = "score-row";
          if(p.rank <= 3){
            row.classList.add("rank-"+p.rank);
          }
          const label = document.createElement("div");
          label.className = "label";
          const medal = document.createElement("span");
          medal.className = "medal";
          const tieMark = scoreCounts[p.score]>1 ? "‚Üî " : "";
          medal.textContent = tieMark + p.rank + ".";
          const name  = document.createElement("span");
          name.className = "name";
          name.textContent  = p.nickname;
          label.appendChild(medal);
          label.appendChild(name);

          const score = document.createElement("span");
          score.className = "score";
          score.textContent = p.score+" p";
          row.appendChild(label);
          row.appendChild(score);
          scoreListEl.appendChild(row);
        });
      });
    }

    async function loadConfig(){
      try{
        const res = await fetch(CONFIG_URL,{cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        CONFIG = await res.json();
        CASES  = (CONFIG.cases || []).slice();
        TOTAL_CASES  = CASES.length;
        configLoaded = true;

        attachDbListeners();
        renderCase();

        rootRef.child("currentCaseIndex").once("value",s=>{
          if(!s.exists()){
            rootRef.update({ currentCaseIndex:0 });
          }
        });
        rootRef.child("sessionToken").once("value",snap=>{
          if(!snap.exists()){
            const t = Date.now();
            rootRef.update({ sessionToken:t });
            sessionToken = t;
            sessionLabel.textContent = "#" + String(t).slice(-4);
          }
        });
      }catch(e){
        console.error(e);
        caseTitleEl.textContent = "Config y√ºklenemedi";
        caseNarrEl.textContent  = "defi-als-config.json dosyasƒ±nƒ± aynƒ± klas√∂re koyduƒüundan emin ol.";
      }
    }

    loadConfig();
  </script>
</body>
</html>

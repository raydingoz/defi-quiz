<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Defi ALS Sim ‚Äì Eƒüitmen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --border:#1f2937;
      --accent:#f97373;
      --danger:#ef4444;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --heading:#fef2f2;
      --radius-lg:20px;
      --radius-pill:999px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:10px;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#7f1d1d 0,#020617 40%,#000 100%);
      color:var(--text);
      font-size:15px;
    }
    .app{max-width:1200px;margin:0 auto;}

    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .brand{
      font-size:1.05rem;
      font-weight:800;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:var(--heading);
    }
    .top-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:var(--radius-pill);
      border:1px solid var(--border);
      padding:4px 10px;
      font-size:0.78rem;
      color:var(--muted);
      background:rgba(15,23,42,0.97);
    }
    .dot-live{
      width:9px;height:9px;border-radius:999px;
      background:var(--danger);
      box-shadow:0 0 12px rgba(239,68,68,0.9);
    }
    .small{font-size:0.78rem;}

    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.7fr) minmax(0,1fr);
      gap:10px;
    }
    @media(max-width:900px){
      .layout{grid-template-columns:minmax(0,1fr);}
    }

    .card{
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:0 18px 40px rgba(15,23,42,0.9);
      padding:10px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top left,rgba(248,113,113,0.16),transparent 60%);
      pointer-events:none;
    }
    .card-inner{position:relative;z-index:1;}

    .section-title{
      font-size:0.9rem;
      color:var(--muted);
      margin-bottom:4px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .case-title{
      font-size:1rem;
      font-weight:600;
      color:var(--heading);
      margin-bottom:4px;
    }
    .case-body{
      font-size:0.9rem;
      color:var(--text);
      white-space:pre-wrap;
      margin-bottom:6px;
    }
    .tag-row{
      display:flex;
      flex-wrap:wrap;
      gap:5px;
      margin-bottom:6px;
    }
    .tag{
      border-radius:var(--radius-pill);
      border:1px solid #374151;
      padding:2px 8px;
      font-size:0.76rem;
      color:var(--muted);
      background:rgba(15,23,42,0.98);
    }

    .progress-wrap{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }
    .progress-label{
      font-size:0.8rem;
      color:var(--muted);
    }
    .progress-track{
      flex:1;
      height:4px;
      border-radius:999px;
      background:#0f172a;
      overflow:hidden;
    }
    .progress-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#f97373,#facc15);
      transition:width .3s ease-out;
    }

    .monitor{
      margin-top:4px;
      border-radius:18px;
      border:1px solid #111827;
      background:radial-gradient(circle at top,#0f172a,#020617 55%);
      padding:8px;
      box-shadow:0 10px 28px rgba(0,0,0,0.8);
      position:relative;
      overflow:hidden;
    }
    .monitor-grid{
      position:absolute;
      inset:0;
      opacity:0.25;
      background-image:
        linear-gradient(to right,#1f2937 1px,transparent 1px),
        linear-gradient(to bottom,#1f2937 1px,transparent 1px);
      background-size:16px 10px;
      pointer-events:none;
    }
    .monitor-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      font-size:0.8rem;
      color:var(--muted);
    }
    .ekg-line{
      position:relative;
      height:80px;
      overflow:hidden;
    }
    .ekg-strip{
      position:absolute;
      top:50%;
      left:0;
      transform:translate3d(0,-50%,0);
      width:720px;
      height:60px;
      display:flex;
    }
    .ekg-strip svg{
      width:240px;
      height:60px;
    }
    .ekg-strip.sinus path{stroke:#22c55e;}
    .ekg-strip.vf path{stroke:#f97373;}
    .ekg-strip.vt path{stroke:#facc15;}
    .ekg-strip.asystole path{stroke:#4b5563;}
    .ekg-strip.pea path{stroke:#38bdf8;}
    .ekg-strip.torsades path{stroke:#f97316;}

    .ekg-strip.anim{
      animation:ekg-move 1.2s linear infinite;
    }
    @keyframes ekg-move{
      from{transform:translate3d(0,-50%,0);}
      to{transform:translate3d(-240px,-50%,0);}
    }

    .monitor-footer{
      margin-top:2px;
      font-size:0.8rem;
      display:flex;
      justify-content:space-between;
      color:var(--muted);
    }

    .timer-pill{
      border-radius:var(--radius-pill);
      border:1px solid #52525b;
      font-size:0.8rem;
      padding:3px 10px;
      color:#fbbf24;
      font-variant-numeric:tabular-nums;
    }

    .btn-row{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .btn{
      border-radius:var(--radius-pill);
      border:1px solid #374151;
      background:rgba(15,23,42,0.97);
      color:var(--text);
      font-size:0.82rem;
      font-weight:600;
      padding:6px 10px;
      display:inline-flex;
      gap:6px;
      align-items:center;
      cursor:pointer;
      transition:all .15s ease-out;
    }
    .btn-main{
      background:radial-gradient(circle at top left,#f97373,#b91c1c);
      border:none;
      color:#fef2f2;
      box-shadow:0 10px 24px rgba(239,68,68,0.7);
    }
    .btn[disabled]{opacity:0.45;cursor:default;box-shadow:none;}
    .btn-danger{color:var(--danger);border-color:#4b5563;}

    .meta-line{
      font-size:0.8rem;
      color:var(--muted);
      margin-top:4px;
    }

    .score-list{
      margin-top:6px;
      font-size:0.86rem;
      max-height:260px;
      overflow-y:auto;
    }
    .score-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:3px 0;
      border-bottom:1px dashed #1f2937;
    }
    .score-row span:first-child{
      max-width:160px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .qr-box{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .qr-frame{
      width:140px;
      height:140px;
      background:#f9fafb;
      border-radius:16px;
      border:2px solid #111827;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 10px 24px rgba(15,23,42,0.9);
    }
    #qrcodeSim{
      width:120px;
      height:120px;
    }
    .qr-text{
      font-size:0.8rem;
      color:var(--muted);
      flex:1 1 120px;
      word-wrap:break-word;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="top-bar">
      <div class="brand">Defi ALS Sim ‚Äì Eƒüitmen</div>
      <div class="top-pill">
        <span class="dot-live"></span>
        <span>ALS ritim kararƒ±</span>
        <span id="sessionLabel" class="small"></span>
      </div>
    </header>

    <main class="layout">
      <!-- SOL: Olgu + monit√∂r -->
      <section class="card">
        <div class="card-inner">
          <div class="section-title">Olgu & Monit√∂r</div>

          <div class="progress-wrap">
            <div class="progress-label" id="progressLabel">Olgu ‚Äì / ‚Äì</div>
            <div class="progress-track">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>

          <div class="case-title" id="caseTitle">Olgu ba≈ülƒ±ƒüƒ±</div>
          <div class="case-body" id="caseNarrative">
            Config y√ºkleniyor (defi-als-config.json)‚Ä¶
          </div>
          <div class="tag-row" id="caseTags"></div>

          <div class="monitor">
            <div class="monitor-grid"></div>
            <div class="monitor-header">
              <span>Lead II</span>
              <span class="timer-pill" id="timerLabel">S√ºre: ‚Äì</span>
            </div>
            <div class="ekg-line">
              <div class="ekg-strip asystole" id="ekgStrip">
                <svg viewBox="0 0 240 60" preserveAspectRatio="none">
                  <polyline id="ekgPath1" fill="none" stroke="#4b5563" stroke-width="2"
                    stroke-linejoin="round" stroke-linecap="round"
                    points="0,30 40,30 80,30 120,30 160,30 200,30 240,30" />
                </svg>
                <svg viewBox="0 0 240 60" preserveAspectRatio="none">
                  <polyline id="ekgPath2" fill="none" stroke="#4b5563" stroke-width="2"
                    stroke-linejoin="round" stroke-linecap="round"
                    points="0,30 40,30 80,30 120,30 160,30 200,30 240,30" />
                </svg>
                <svg viewBox="0 0 240 60" preserveAspectRatio="none">
                  <polyline id="ekgPath3" fill="none" stroke="#4b5563" stroke-width="2"
                    stroke-linejoin="round" stroke-linecap="round"
                    points="0,30 40,30 80,30 120,30 160,30 200,30 240,30" />
                </svg>
              </div>
            </div>
            <div class="monitor-footer">
              <span>HR: ?</span>
              <span>SpO‚ÇÇ: ?</span>
            </div>
          </div>

          <div class="btn-row">
            <button id="btnPrev" class="btn">‚üµ √ñnceki olgu</button>
            <button id="btnNext" class="btn">Sonraki olgu ‚ü∂</button>
            <button id="btnStartCase" class="btn btn-main">‚ñ∂ Ritim + s√ºreyi ba≈ülat</button>
            <button id="btnReveal" class="btn">‚úÖ Doƒüru yakla≈üƒ±mƒ± g√∂ster</button>
          </div>
          <div class="meta-line" id="statusLine">
            Olguyu tanƒ±t; hazƒ±r olduƒüunda ‚ÄúRitim + s√ºreyi ba≈ülat‚Äù ile hem sende hem katƒ±lƒ±mcƒ±larda ritmi a√ß.
          </div>
        </div>
      </section>

      <!-- SAƒû: QR + skor -->
      <aside class="card">
        <div class="card-inner">
          <div class="section-title">Katƒ±lƒ±mcƒ±lar & QR</div>

          <div class="qr-box">
            <div class="qr-frame">
              <div id="qrcodeSim"></div>
            </div>
            <div class="qr-text">
              Katƒ±lƒ±mcƒ±lar bu QR‚Äôƒ± okutup <strong>ALS sim</strong> katƒ±lƒ±mcƒ± sayfasƒ±na baƒülanƒ±r.
              <br/><br/>
              Kƒ±sa URL:<br/>
              <span id="playerUrlText" class="small"></span>
            </div>
          </div>

          <div class="meta-line" style="margin-top:8px;">
            Toplam katƒ±lƒ±mcƒ±: <span id="playerCount">0</span>
          </div>

          <div class="section-title" style="margin-top:8px;">Skor Tablosu</div>
          <div id="scoreList" class="score-list"></div>

          <div class="btn-row" style="margin-top:8px;">
            <button id="btnResetSession" class="btn btn-danger small">
              üîÅ Oturumu sƒ±fƒ±rla
            </button>
          </div>
          <div class="meta-line small">
            Oturumu sƒ±fƒ±rladƒ±ƒüƒ±nda: t√ºm skorlar, yanƒ±tlar ve eski nickler silinir.
            QR aynƒ± kalƒ±r; herkes yeniden nickname girer.
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDzzwE5VHZAiP2k8P_iocDaq7uGm1zN1cE",
      authDomain: "defi-quiz.firebaseapp.com",
      databaseURL: "https://defi-quiz-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "defi-quiz",
      storageBucket: "defi-quiz.firebasestorage.app",
      messagingSenderId: "642741899462",
      appId: "1:642741899462:web:bcc787a87d0ec69c9b47c7",
      measurementId: "G-SY348RPCVZ"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db     = firebase.database();
    const rootRef= db.ref("defiSim");

    const CONFIG_URL = "defi-als-config.json";

    let CONFIG       = null;
    let CASES        = [];
    let TOTAL_CASES  = 0;
    let configLoaded = false;

    let sessionToken        = null;
    let currentIndex        = 0;
    let currentCaseId       = null;
    let currentRhythmActive = false;
    let currentReveal       = false;

    let timerInterval = null;
    let timerRemaining = 0;

    // DOM
    const caseTitleEl   = document.getElementById("caseTitle");
    const caseNarrEl    = document.getElementById("caseNarrative");
    const caseTagsEl    = document.getElementById("caseTags");
    const timerLabel    = document.getElementById("timerLabel");
    const statusLine    = document.getElementById("statusLine");

    const btnPrev       = document.getElementById("btnPrev");
    const btnNext       = document.getElementById("btnNext");
    const btnStart      = document.getElementById("btnStartCase");
    const btnReveal     = document.getElementById("btnReveal");
    const btnReset      = document.getElementById("btnResetSession");

    const ekgStripEl    = document.getElementById("ekgStrip");
    const ekgPath1      = document.getElementById("ekgPath1");
    const ekgPath2      = document.getElementById("ekgPath2");
    const ekgPath3      = document.getElementById("ekgPath3");

    const sessionLabel  = document.getElementById("sessionLabel");
    const playerCountEl = document.getElementById("playerCount");
    const scoreListEl   = document.getElementById("scoreList");
    const playerUrlText = document.getElementById("playerUrlText");

    const progressLabel = document.getElementById("progressLabel");
    const progressFill  = document.getElementById("progressFill");

    // EKG ≈üekilleri
    const EKG_SHAPES = {
      sinus: "0,30 10,30 20,30 30,20 32,40 34,10 36,50 38,25 40,30 50,30 60,30 70,30 80,30 90,20 92,40 94,12 96,50 98,25 100,30 110,30 120,30 130,30 140,20 142,40 144,10 146,50 148,25 150,30 160,30 170,30 180,30 190,20 192,40 194,12 196,50 198,25 200,30 210,30 220,30 230,30 240,30",
      vf:   "0,30 6,35 8,26 13,26 18,36 20,37 26,25 28,24 31,33 34,36 38,26 40,26 46,34 53,36 58,30 61,26 68,26 75,27 77,37 78,34 83,33 88,27 92,29 96,37 103,37 109,29 112,26 120,25 127,29 127,35 128,32 135,33 138,26 139,33 141,41 143,28 146,36 148,38 154,28 160,32 164,41 171,36 173,29 179,37 183,42 186,41 189,28 193,25 199,27 204,35 207,33 212,25 216,28 218,37 220,37 227,27 233,23 236,28 240,30",
      vt:   "0,30 5,30 10,20 15,10 20,50 25,40 30,30 35,30 40,20 45,10 50,50 55,40 60,30 65,30 70,20 75,10 80,50 85,40 90,30 95,30 100,20 105,10 110,50 115,40 120,30 125,30 130,20 135,10 140,50 145,40 150,30 155,30 160,20 165,10 170,50 175,40 180,30 185,30 190,20 195,10 200,50 205,40 210,30 215,30 220,20 225,10 230,50 235,40 240,30",
      asystole: "0,30 40,30 80,30 120,30 160,30 200,30 240,30",
      pea:  "0,30 10,30 20,30 28,20 30,18 32,40 34,22 36,30 46,30 56,30 64,22 66,40 68,18 70,30 80,30 90,30 98,22 100,40 102,18 104,30 114,30 124,30 132,22 134,40 136,18 138,30 148,30 158,30 166,22 168,40 170,18 172,30 182,30 192,30 200,22 202,40 204,18 206,30 216,30 226,30 234,22 236,40 238,18 240,30",
      torsades: "0,30 5,25 10,20 15,15 20,10 25,15 30,20 35,25 40,30 45,35 50,40 55,45 60,50 65,45 70,40 75,35 80,30 85,25 90,20 95,15 100,10 105,15 110,20 115,25 120,30 125,35 130,40 135,45 140,50 145,45 150,40 155,35 160,30 165,25 170,20 175,15 180,10 185,15 190,20 195,25 200,30 205,35 210,40 215,45 220,50 225,45 230,40 235,35 240,30"
    };

    function safeCase(idx){
      if(!CASES.length) return null;
      if(idx<0) idx=0;
      if(idx>=CASES.length) idx=CASES.length-1;
      return CASES[idx];
    }

    function stopTimer(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function startTimerForCurrent(){
      stopTimer();
      const c = safeCase(currentIndex);
      if(!c){
        timerLabel.textContent="S√ºre: ‚Äì";
        return;
      }
      timerRemaining = c.timeLimitSec || 8;
      timerLabel.textContent = "S√ºre: "+timerRemaining+" sn";
      timerInterval = setInterval(()=>{
        timerRemaining -= 1;
        if(timerRemaining <= 0){
          stopTimer();
          timerLabel.textContent = "S√ºre: 0 sn";
          rootRef.update({ currentRhythmActive:false });
        }else{
          timerLabel.textContent="S√ºre: "+timerRemaining+" sn";
        }
      },1000);
    }

    function applyRhythm(key, animate){
      const k = key || "sinus";
      const shape = EKG_SHAPES[k] || EKG_SHAPES["sinus"];
      ekgPath1.setAttribute("points", shape);
      ekgPath2.setAttribute("points", shape);
      ekgPath3.setAttribute("points", shape);
      ekgStripEl.className = "ekg-strip " + k + (animate ? " anim" : "");
    }

    function updateProgress(){
      if(!TOTAL_CASES || currentIndex==null){
        progressLabel.textContent = "Olgu ‚Äì / ‚Äì";
        progressFill.style.width  = "0%";
        return;
      }
      const idx = currentIndex + 1;
      progressLabel.textContent = "Olgu " + idx + " / " + TOTAL_CASES;
      const pct = Math.max(0, Math.min(1, idx / TOTAL_CASES));
      progressFill.style.width = (pct * 100).toFixed(1) + "%";
    }

    function renderCase(){
      if(!configLoaded) return;
      const c = safeCase(currentIndex);
      if(!c) return;

      caseTitleEl.textContent = c.title || ("Olgu " + (currentIndex+1));
      caseNarrEl.textContent  = c.narrative || "";
      caseTagsEl.innerHTML = "";
      (c.tags || []).forEach(t=>{
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = t;
        caseTagsEl.appendChild(span);
      });

      const rhythmKey = (currentRhythmActive && currentCaseId && c.rhythmKey) ? c.rhythmKey : "asystole";
      applyRhythm(rhythmKey, !!currentRhythmActive);

      if(!currentCaseId){
        statusLine.textContent = "Olguyu tanƒ±t, sonra 'Ritim + s√ºreyi ba≈ülat' ile ritmi a√ß.";
      }else if(!currentRhythmActive && !currentReveal){
        statusLine.textContent = "Ritim kapalƒ±. Aynƒ± olguyu tekrar ba≈ülatabilir veya yeni olguya ge√ßebilirsin.";
      }else if(currentRhythmActive){
        statusLine.textContent = "Ritim a√ßƒ±k, katƒ±lƒ±mcƒ±lar karar veriyor.";
      }else if(currentReveal){
        statusLine.textContent = "Doƒüru yakla≈üƒ±m g√∂sterildi, olguyu tartƒ±≈üabilirsin.";
      }

      updateProgress();
    }

    function initQR(){
      try{
        let href = window.location.href;
        const playerUrl = href.replace(/defi-sim-host(\.html)?/,"defi-sim-player.html");
        playerUrlText.textContent = playerUrl;
        const box = document.getElementById("qrcodeSim");
        box.innerHTML = "";
        new QRCode(box,{
          text: playerUrl,
          width:120,
          height:120
        });
      }catch(e){console.error(e);}
    }
    initQR();

    // Butonlar
    btnPrev.addEventListener("click",()=>{
      if(!configLoaded) return;
      currentIndex = Math.max(0, currentIndex-1);
      currentCaseId = null;
      currentRhythmActive = false;
      currentReveal = false;
      stopTimer();
      timerRemaining = 0;
      timerLabel.textContent = "S√ºre: ‚Äì";
      rootRef.update({
        currentCaseIndex: currentIndex,
        currentCaseId: null,
        currentRhythmActive: false,
        currentReveal: false
      });
      renderCase();
    });

    btnNext.addEventListener("click",()=>{
      if(!configLoaded) return;
      currentIndex = Math.min(TOTAL_CASES-1, currentIndex+1);
      currentCaseId = null;
      currentRhythmActive = false;
      currentReveal = false;
      stopTimer();
      timerRemaining = 0;
      timerLabel.textContent = "S√ºre: ‚Äì";
      rootRef.update({
        currentCaseIndex: currentIndex,
        currentCaseId: null,
        currentRhythmActive: false,
        currentReveal: false
      });
      renderCase();
    });

    function startCase(){
      if(!configLoaded) return;
      const c = safeCase(currentIndex);
      if(!c) return;
      const newId = "c_" + c.id + "_" + Date.now();

      currentCaseId       = newId;
      currentRhythmActive = true;
      currentReveal       = false;

      stopTimer();
      startTimerForCurrent();

      const updates = {};
      updates["currentCaseIndex"]       = currentIndex;
      updates["currentCaseId"]          = currentCaseId;
      updates["currentRhythmActive"]    = true;
      updates["currentReveal"]          = false;
      updates["answerOrder/"+currentCaseId] = 0;
      updates["answers/"+currentCaseId]     = null;
      rootRef.update(updates);

      statusLine.textContent = "Ritim a√ßƒ±ldƒ±, s√ºre ba≈üladƒ±.";
      renderCase();
    }
    btnStart.addEventListener("click", startCase);

    btnReveal.addEventListener("click",()=>{
      if(!currentCaseId) return;
      rootRef.update({ currentReveal:true, currentRhythmActive:false });
      stopTimer();
      timerLabel.textContent = "S√ºre: 0 sn";
    });

    btnReset.addEventListener("click",()=>{
      if(!confirm("T√ºm skorlar, yanƒ±tlar ve eski nickler silinecek. Emin misin?")) return;
      stopTimer();
      const newToken = Date.now();
      const resetData = {
        sessionToken:newToken,
        currentCaseIndex:0,
        currentCaseId:null,
        currentRhythmActive:false,
        currentReveal:false,
        players:null,
        answers:null,
        answerOrder:null
      };
      rootRef.set(resetData);
      sessionToken = newToken;
      sessionLabel.textContent = "#" + String(newToken).slice(-4);

      currentIndex        = 0;
      currentCaseId       = null;
      currentRhythmActive = false;
      currentReveal       = false;
      timerRemaining      = 0;
      timerLabel.textContent = "S√ºre: ‚Äì";
      scoreListEl.innerHTML   = "";
      playerCountEl.textContent = "0";
      statusLine.textContent = "Yeni ALS sim oturumu ba≈ülatƒ±ldƒ±.";
      renderCase();
    });

    function attachDbListeners(){
      rootRef.child("sessionToken").on("value",snap=>{
        const val = snap.val();
        if(val){
          if(sessionToken && sessionToken !== val){
            stopTimer();
            timerRemaining = 0;
            timerLabel.textContent = "S√ºre: ‚Äì";
            currentCaseId = null;
            currentRhythmActive = false;
            currentReveal = false;
            statusLine.textContent = "Yeni oturum algƒ±landƒ±.";
          }
          sessionToken = val;
          sessionLabel.textContent = "#" + String(val).slice(-4);
        }
      });

      rootRef.child("currentCaseIndex").on("value",snap=>{
        const idx = snap.val();
        if(idx === null || idx === undefined) return;
        currentIndex = idx;
        renderCase();
      });

      rootRef.child("currentCaseId").on("value",snap=>{
        currentCaseId = snap.val();
        renderCase();
      });

      rootRef.child("currentRhythmActive").on("value",snap=>{
        currentRhythmActive = !!snap.val();
        if(currentRhythmActive){
          startTimerForCurrent();
        }else{
          stopTimer();
          if(currentCaseId){
            timerLabel.textContent = "S√ºre: 0 sn";
          }else{
            timerLabel.textContent = "S√ºre: ‚Äì";
          }
        }
        renderCase();
      });

      rootRef.child("currentReveal").on("value",snap=>{
        currentReveal = !!snap.val();
        renderCase();
      });

      rootRef.child("players").on("value",snap=>{
        const val = snap.val() || {};
        const arr = Object.entries(val).map(([id,p])=>({
          id,
          nickname: p.nickname || "Anonim",
          score:    p.score    || 0
        }));
        arr.sort((a,b)=> b.score - a.score || (a.nickname > b.nickname ? 1 : -1));
        playerCountEl.textContent = arr.length;
        scoreListEl.innerHTML = "";
        arr.forEach((p,idx)=>{
          const row  = document.createElement("div");
          row.className = "score-row";
          const left  = document.createElement("span");
          const right = document.createElement("span");
          left.textContent  = (idx+1)+". "+p.nickname;
          right.textContent = p.score+" p";
          row.appendChild(left);
          row.appendChild(right);
          scoreListEl.appendChild(row);
        });
      });
    }

    async function loadConfig(){
      try{
        const res = await fetch(CONFIG_URL,{cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        CONFIG = await res.json();
        CASES  = (CONFIG.cases || []).slice();
        TOTAL_CASES  = CASES.length;
        configLoaded = true;

        attachDbListeners();
        renderCase();

        rootRef.child("currentCaseIndex").once("value",s=>{
          if(!s.exists()){
            rootRef.update({ currentCaseIndex:0 });
          }
        });
        rootRef.child("sessionToken").once("value",snap=>{
          if(!snap.exists()){
            const t = Date.now();
            rootRef.update({ sessionToken:t });
            sessionToken = t;
            sessionLabel.textContent = "#" + String(t).slice(-4);
          }
        });
      }catch(e){
        console.error(e);
        caseTitleEl.textContent = "Config y√ºklenemedi";
        caseNarrEl.textContent  = "defi-als-config.json dosyasƒ±nƒ± aynƒ± klas√∂re koyduƒüundan emin ol.";
      }
    }

    loadConfig();
  </script>
</body>
</html>
